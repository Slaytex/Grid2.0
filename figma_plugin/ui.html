<!DOCTYPE html>
<html>
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: 'Quicksand', sans-serif;
    width: 350px;
    height: 500px;
    display: flex;
    flex-direction: column;
    background: #1E1E1E;
    overflow: hidden; /* Prevent any scrolling on body */
    text-transform: uppercase; /* Make all text uppercase */
    font-weight: 600; /* Make all text heavier */
  }

  /* Header */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: url("data:image/svg+xml,%3Csvg width='350' height='70' viewBox='0 0 350 70' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='350' height='70' fill='%23404040'/%3E%3Cpath d='M204.46 0L350 0V70H165L204.46 0Z' fill='%23323232'/%3E%3C/svg%3E") center center / cover no-repeat;
  }

  .logo {
    display: flex;
    align-items: center;
  }

  .grid-icon {
    width: 116px;
    height: 34px;
    margin-bottom: 4px;
  }

  .connection-status, .status-text {
    display: flex;
    align-items: center;
    gap: 8px;
    color: white; 
    font-size: 9px; 
    letter-spacing: 3px;
    font-family: 'Quicksand', sans-serif;
    font-weight: 600;
    cursor: pointer;
  }

  .connection-status:hover {
    opacity: 0.8;
  }

  .status-light {
    position: relative;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4CAF50;
    z-index: 2;
  }

  .status-light .glow {
    position: absolute;
    top: -4px;
    left: -4px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #4CAF50;
    filter: blur(3px);
    animation: pulse-green 2s ease-in-out infinite;
    z-index: 1;
    opacity: 0.8;
  }

  @keyframes pulse-green {
    0% { opacity: 0.4; }
    50% { opacity: 0.8; }
    100% { opacity: 0.4; }
  }

  .status-light.disconnected {
    background: #F44336;
    animation: flash-red 0.8s linear infinite;
  }

  .status-light.disconnected .glow {
    display: none;
  }

  @keyframes flash-red {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
  }

  /* Frame List - only this should scroll vertically */
  .frame-list {
    flex: 1;
    background: color(display-p3 0.118 0.118 0.118);
    padding: 20px;
    overflow-y: auto;  /* Allow vertical scroll */
    overflow-x: hidden; /* Prevent horizontal scroll */
    font-family: 'Quicksand', sans-serif;
    color: white;
  }

  /* Custom checkbox styles */
  .frame-item {
    position: relative;
    padding-left: 28px;
    cursor: pointer;
    font-size: 12px;
    user-select: none;
    display: flex;
    align-items: center;
    margin: 8px 0;
  }

  .frame-item input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
  }

  .frame-item label:before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    border: 1px solid color(display-p3 0.3 0.3 0.3);
    background: color(display-p3 0.15 0.15 0.15);
    transition: all 0.2s ease;
  }

  .frame-item input[type="checkbox"]:checked + label:before {
    background: color(display-p3 0.823 0.795 0.503);
    border-color: color(display-p3 0.823 0.795 0.503);
  }

  .frame-item label:after {
    content: '';
    position: absolute;
    left: 6px;
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
    width: 4px;
    height: 8px;
    border: solid white;
    border-width: 0 2px 2px 0;
    opacity: 0;
    transition: all 0.2s ease;
  }

  .frame-item input[type="checkbox"]:checked + label:after {
    opacity: 1;
  }

  .frame-item:hover label:before {
    border-color: color(display-p3 0.823 0.795 0.503);
  }

  /* Button */
  .button-container {
    width: 100%;
    background-color: color(display-p3 0.118 0.118 0.118);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 16px;
  }

  .send-button {
    border-radius: 0px;
    border: none;
    background: color(display-p3 0.118 0.118 0.118);
    color: white;
    font-size: 11px;
    letter-spacing: 2px;
    cursor: pointer;
    transition: border 0.3s, letter-spacing 0.3s;
    border: 1px solid color(display-p3 0.217 0.217 0.217);
    width: calc(100% - 32px);
    height: 40px;
    font-family: 'Quicksand', sans-serif;
  }

  .send-button:hover {
    border: 1px solid color(display-p3 0.723 0.695 0.403);
    letter-spacing: 4px;
  }

  .send-button.sending {
    background: color(display-p3 0.118 0.118 0.118);
    color: #4a9fea; /* Blue text for processing states */
    cursor: wait;
  }

  /* Highlight state for SEND LIVE when a #live frame is selected */
  .send-button.live-active {
    border: 1px solid #77c2ea;
    letter-spacing: 4px;
  }

  .send-button.success {
    background: #4CAF50;
    color: white;
  }

  .send-button.error {
    background: #F44336;
    color: white;
  }

  @keyframes flash-red-button {
    0% { background-color: #F44336; }
    50% { background-color: #641E16; }
    100% { background-color: #F44336; }
  }

  @keyframes flash-orange-button {
    0% { background-color: #FF9800; }
    50% { background-color: #E65100; }
    100% { background-color: #FF9800; }
  }

  .send-button.flash-error {
    animation: flash-red-button 0.4s linear 2;
  }

  .send-button.flash-warning {
    animation: flash-orange-button 0.4s linear 2;
    background-color: #FF9800;
  }

  /* Console - only this should scroll vertically */
  .console {
    padding: 16px;
    background: #1E1E1E;
    color: #00FF00;
    font-family: monospace;
    font-size: 9px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }

  .console.visible {
    max-height: 150px;
  }

  .console-content {
    height: 150px;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .console-header {
    color: white;
    font-size: 9px;
    letter-spacing: 2px;
    margin-bottom: 8px;
    font-family: 'Quicksand', sans-serif;
    padding-bottom: 5px;
    border-bottom: 1px solid rgb(101, 101, 101);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .clear-console {
    color: #666666;
    cursor: pointer;
    font-size: 14px;
    padding: 0 4px;
    transition: color 0.2s ease;
  }

  .clear-console:hover {
    color: #999999;
  }

  /* Custom scrollbar styling */
  .frame-list::-webkit-scrollbar,
  .console::-webkit-scrollbar {
      width: 8px;  /* width of the entire scrollbar */
  }

  .frame-list::-webkit-scrollbar-track,
  .console::-webkit-scrollbar-track {
      background: #1E1E1E;  /* color of the tracking area */
  }

  .frame-list::-webkit-scrollbar-thumb,
  .console::-webkit-scrollbar-thumb {
      background: #333333;  /* color of the scroll thumb */
      border-radius: 4px;  /* roundness of the scroll thumb */
  }

  /* Hover state */
  .frame-list::-webkit-scrollbar-thumb:hover,
  .console::-webkit-scrollbar-thumb:hover {
      background: #444444;  /* color of the scroll thumb on hover */
  }

  .frame-list-header {
    color: white;
    font-size: 9px;
    letter-spacing: 2px;
    margin-bottom: 8px;
    font-family: 'Quicksand', sans-serif;
    padding-bottom: 5px;
    border-bottom: 1px solid rgb(101, 101, 101);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .refresh-icon {
    color: #e0e0e0;
    cursor: pointer;
    padding: 4px;
    transition: transform 0.2s ease;
    display: flex;
    align-items: center;
  }

  .refresh-icon svg {
    width: 18px;
    height: 18px;
  }

  .refresh-icon svg path {
    fill: #77c2ea;
    transition: fill 0.2s ease;
  }

  .refresh-icon:hover svg path {
    fill: #ffffff;
  }

  .refresh-icon:hover {
    transform: rotate(180deg);
  }

  /* Add these new styles */
  .no-frames {
    color: #888;
    text-align: center;
    padding: 20px;
    font-size: 12px;
  }
  
  .confirmation {
    padding: 10px;
    text-align: center;
  }
  
  .confirmation p {
    margin-bottom: 15px;
    font-size: 12px;
  }
  
  .confirmation-buttons {
    display: flex;
    justify-content: space-between;
  }
  
  .confirm-button {
    flex: 1;
    margin: 0 5px;
    padding: 8px;
    background: color(display-p3 0.118 0.118 0.118);
    color: white;
    border: 1px solid color(display-p3 0.217 0.217 0.217);
    cursor: pointer;
    font-size: 11px;
    transition: all 0.2s;
    font-family: 'Quicksand', sans-serif;
  }
  
  .confirm-button:hover {
    border-color: color(display-p3 0.723 0.695 0.403);
  }
  
  .confirm-button.secondary {
    background: transparent;
  }
  
  .loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px;
  }
  
  .spinner {
    width: 30px;
    height: 30px;
    border: 3px solid rgba(255,255,255,0.1);
    border-radius: 50%;
    border-top-color: color(display-p3 0.723 0.695 0.403);
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .grid-info {
    background-color: #2c2c2c;
    border-radius: 4px;
    overflow: hidden;
  }

  .grid-info-header {
    background-color: #3971aa;
    color: white;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 600;
  }

  .grid-info-content {
    font-size: 11px;
    color: #ddd;
    line-height: 1.5;
    padding: 6px 15px;
  }

  .loading-info {
    color: #888;
    text-align: center;
    padding: 20px;
    font-size: 12px;
  }

  .connect-prompt {
    color: #888;
    text-align: center;
    padding: 20px;
    font-size: 12px;
  }

  .error-info {
    color: #F44336;
    text-align: center;
    padding: 20px;
    font-size: 12px;
  }

  .help-link {
    display: block;
    color: white;
    text-decoration: none;
    text-align: center;
    font-size: 9px;
    cursor: pointer;
    transition: all 0.2s ease;
    letter-spacing: 1px;
    padding: 5px 0;
  }

  .help-link:hover {
    background: #91cd77;
    letter-spacing: 1.5px;
    color: #2e4226;
  }

  .footer {
    padding: 16px;
    background: #1E1E1E;
    border-top: 1px solid #333;
    text-align: center;
    cursor: pointer; /* Add pointer cursor to indicate clickable */
    transition: background-color 0.2s ease;
  }

  .footer:hover {
    background: #2a2a2a; /* Subtle hover effect */
  }

  .footer-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #577896;
    font-size: 11px;
    letter-spacing: 1px;
  }

  .footer svg {
    height: 16px;
    width: auto;
  }
</style>

<div class="header">
  <div class="logo">
    <svg width="116" height="35" viewBox="0 0 116 35" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M105.827 12.7375H109.507C111.227 12.7375 112.517 13.2154 113.378 14.1712C114.238 15.1164 114.668 16.5129 114.668 18.3608C114.668 22.1203 112.894 24 109.347 24H105.827V12.7375ZM109.268 22.8212C110.733 22.8212 111.774 22.4601 112.39 21.7379C113.016 21.0158 113.33 19.8901 113.33 18.3608C113.33 16.8315 113.027 15.7111 112.422 14.9995C111.816 14.2774 110.807 13.9163 109.395 13.9163H107.165V22.8212H109.268Z" fill="white"/>
      <path d="M88.3424 22.8212H90.0628V13.9163H88.3424V12.7375H93.1214V13.9163H91.401V22.8212H93.1214V24H88.3424V22.8212Z" fill="white"/>
      <path d="M71.9442 18.3767C72.6664 18.3767 73.2133 18.2971 73.585 18.1378C73.9673 17.9785 74.2275 17.7448 74.3656 17.4368C74.5037 17.1182 74.5727 16.6881 74.5727 16.1465C74.5727 15.6049 74.5037 15.1801 74.3656 14.8721C74.2275 14.5535 73.9673 14.3146 73.585 14.1553C73.2133 13.996 72.6664 13.9163 71.9442 13.9163H69.491V18.3767H71.9442ZM69.491 19.5555V24H68.1529V12.7375H72.008C73.4204 12.7375 74.424 13.0295 75.0187 13.6136C75.6134 14.1977 75.9108 15.042 75.9108 16.1465C75.9108 17.028 75.7515 17.7395 75.4329 18.2811C75.1143 18.8121 74.5514 19.1785 73.7443 19.3803L76.3568 24H74.8116L72.3425 19.5555H72.0239H69.491Z" fill="white"/>
      <path d="M51.4711 19.5077V18.3448H55.82V19.5874C55.82 20.4476 55.6554 21.2229 55.3261 21.9132C55.0075 22.5928 54.5084 23.1398 53.8287 23.554C53.149 23.9575 52.2941 24.1593 51.264 24.1593C49.6816 24.1593 48.4603 23.6602 47.6001 22.6619C46.7505 21.6636 46.3257 20.2299 46.3257 18.3608C46.3257 16.5023 46.7505 15.0739 47.6001 14.0756C48.4603 13.0773 49.6816 12.5782 51.264 12.5782C52.4534 12.5782 53.4464 12.8915 54.2429 13.5181C55.05 14.134 55.5438 15.0102 55.7244 16.1465H54.3385C54.0624 14.5535 53.0375 13.757 51.264 13.757C48.8639 13.757 47.6638 15.2916 47.6638 18.3608C47.6638 19.9219 47.9665 21.0795 48.5718 21.8335C49.1772 22.5875 50.0745 22.9645 51.264 22.9645C52.5278 22.9645 53.3827 22.6247 53.8287 21.945C54.2748 21.2547 54.4925 20.4423 54.4818 19.5077H51.4711Z" fill="white"/>
      <rect x="10.9903" y="14.5299" width="15.0938" height="15.0147" fill="#5BC4EE"/>
      <rect x="10.9113" y="6.94355" width="15.1728" height="7.58639" fill="#91CD77"/>
      <rect x="26.3211" y="14.688" width="7.11224" height="7.19126" fill="#EB6363"/>
      <line x1="10.9215" y1="2.18131" x2="10.9215" y2="33.9204" stroke="white" stroke-width="0.473717" stroke-linecap="round"/>
      <line x1="18.501" y1="2.18131" x2="18.501" y2="33.9204" stroke="white" stroke-width="0.473717" stroke-linecap="round"/>
      <line x1="26.0804" y1="2.18131" x2="26.0804" y2="33.9204" stroke="white" stroke-width="0.473717" stroke-linecap="round"/>
      <line x1="33.6599" y1="2.18131" x2="33.6599" y2="33.9204" stroke="white" stroke-width="0.473717" stroke-linecap="round"/>
      <line x1="38.8708" y1="6.91849" x2="5.23687" y2="6.91849" stroke="white" stroke-width="0.473717" stroke-linecap="round"/>
      <line x1="38.8708" y1="14.498" x2="5.23687" y2="14.498" stroke="white" stroke-width="0.473717" stroke-linecap="round"/>
      <line x1="38.8708" y1="22.0774" x2="5.23687" y2="22.0774" stroke="white" stroke-width="0.473717" stroke-linecap="round"/>
      <line x1="38.8708" y1="29.6569" x2="5.23687" y2="29.6569" stroke="white" stroke-width="0.473717" stroke-linecap="round"/>
      </svg>
      
  </div>
  <div class="connection-status">
    <span class="status-text">CONNECTED</span>
    <div class="status-light">
      <div class="glow"></div>
    </div>
  </div>
</div>

<a href="https://css-playground-f31b22.webflow.io/" target="_blank" class="help-link">Instructions here →</a>


<div class="grid-info">
  <div class="grid-info-content">
    <!-- Screen info will be displayed dynamically -->
  </div>
</div>


<div class="frame-list">
  <div class="frame-list-header">
    <span>FRAMES</span>
    <span class="refresh-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M17.6498 6.35C16.9096 5.60494 16.0293 5.01371 15.0596 4.61039C14.0899 4.20706 13.05 3.99962 11.9998 4C7.57977 4 4.00977 7.58 4.00977 12C4.00977 16.42 7.57977 20 11.9998 20C15.7298 20 18.8398 17.45 19.7298 14H17.6498C17.2378 15.1695 16.4731 16.1824 15.4611 16.8988C14.4491 17.6153 13.2397 18 11.9998 18C8.68977 18 5.99977 15.31 5.99977 12C5.99977 8.69 8.68977 6 11.9998 6C13.6598 6 15.1398 6.69 16.2198 7.78L12.9998 11H19.9998V4L17.6498 6.35Z"/>
      </svg>
    </span>
  </div>
  <div id="frameList">
    <!-- Frames will be inserted here -->
  </div>
</div>

<div class="button-container">
  <button id="nameFrameButton" class="send-button">NAME FRAME</button>
  <button id="sendLiveButton" class="send-button">SEND LIVE</button>
  <button id="resizeButton" class="send-button">RESIZE GRID FRAME</button>
  <button id="castButton" class="send-button">
    SEND TO GRID
  </button>
</div>

<div class="console">
  <div class="console-header">
    <span>CONSOLE</span>
    <span class="clear-console">×</span>
  </div>
  <div id="debug"></div>
</div>

<div class="footer">
  <div class="footer-content">
    <svg width="124" height="26" viewBox="0 0 124 26" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M13.4656 20.8193C13.2791 21.325 13.3884 21.9691 13.3714 22.5143C13.3686 22.5972 13.4185 23.4843 13.184 23.1726C13.2113 22.358 13.104 21.5255 13.2773 20.7251C13.3573 20.7449 13.443 20.8155 13.4656 20.8193Z" fill="#577896"/>
      <path d="M27.8133 15.8039C27.6268 16.3096 27.736 16.9537 27.7191 17.4989C27.7163 17.5818 27.7662 18.4689 27.5317 18.1572C27.559 17.3426 27.4516 16.5102 27.6249 15.7097C27.705 15.7295 27.7906 15.8001 27.8133 15.8039Z" fill="#577896"/>
      <path d="M36.0066 15.0505C35.8202 15.5562 35.9294 16.2003 35.9124 16.7455C35.9096 16.8284 35.9595 17.7155 35.725 17.4038C35.7524 16.5892 35.645 15.7567 35.8183 14.9563C35.8983 14.9761 35.984 15.0467 36.0066 15.0505Z" fill="#577896"/>
      <path d="M14.4072 20.8193V20.9135C14.1172 20.8419 14.2283 21.132 14.2189 21.3844C14.2085 21.6697 14.1502 22.117 14.3131 22.3261C14.2839 22.4946 14.3941 22.6886 14.2189 22.7969C14.2566 22.5304 14.0871 22.5304 14.1247 22.7969C13.9722 22.7056 14.0409 22.5737 14.0306 22.4202C14.024 22.327 14.0334 22.2319 14.0306 22.1377C14.0221 21.8872 14.0409 21.6348 14.0306 21.3844C14.0164 21.034 14.1445 20.9493 13.748 20.8193C13.9449 20.8344 14.2114 20.8353 14.4072 20.8193Z" fill="#577896"/>
      <path d="M14.4081 21.3843C14.41 21.7826 14.3761 21.9653 14.314 22.326C14.1511 22.1169 14.2094 21.6696 14.2198 21.3843H14.4081Z" fill="#577896"/>
      <path d="M19.4932 4.15118C19.6128 4.1427 19.7493 4.14459 19.8698 4.15118C21.0432 4.21804 21.3229 4.94032 21.2824 6.03458C21.1647 6.07978 21.1854 6.2135 21.1882 6.31709C21.2221 7.5526 20.3755 8.9981 19.6815 9.98971C19.6627 10.0161 19.5977 10.0387 19.5873 10.0839H19.4932L19.3048 9.98971C19.2408 9.97653 18.8538 9.97747 18.834 9.98971C18.9922 9.80796 18.8114 9.37007 18.8509 9.11958C18.9338 8.60071 19.6052 7.5008 19.803 6.86139C20.2333 5.46862 20.4386 4.59001 18.7398 5.46862C18.269 5.71157 18.2002 5.76054 17.8923 6.12781C17.8668 6.15794 17.6653 6.09202 17.6098 6.50449H17.5156C17.5109 6.43103 17.5523 6.31426 17.4685 6.3152C17.3828 6.31426 17.4252 6.43951 17.4214 6.50449C17.3395 6.50354 17.2934 6.5591 17.2331 6.59866C17.0645 6.70883 17.0551 6.77946 16.9506 6.88116C16.702 7.12412 16.427 7.37556 16.1972 7.63452C15.6614 8.24004 15.0804 8.93878 14.6905 9.70626C14.6152 9.85411 14.5634 10.0227 14.5022 10.1771C14.0888 10.3042 14.231 10.6188 14.2197 10.648C14.1453 10.8335 13.9974 11.0472 13.9371 11.213C13.6857 11.1687 13.7441 11.2732 13.7488 11.4955C13.7319 11.5124 13.6848 11.8599 13.6546 11.9663C13.455 11.9428 13.4427 11.955 13.4663 12.1547C13.4427 12.1801 13.3053 12.7122 13.278 12.8139C13.1433 12.8553 13.0887 12.9579 13.0896 13.0964C13.083 13.103 13.0821 13.2433 13.0896 13.2847L12.9954 13.4731C12.9323 13.5211 12.518 14.8009 12.4756 14.9779C12.2167 16.0477 12.0575 17.9668 12.695 18.9067C13.4616 20.0376 14.9005 19.4971 15.8215 18.8407C15.9684 18.7362 16.2161 18.7381 16.1982 18.4641C16.2829 18.4245 16.5183 18.3115 16.5748 18.2757C16.7679 18.303 16.7905 18.2804 16.7632 18.0874C16.9383 17.9565 17.2924 17.674 17.4224 17.5224L17.849 17.3378L18.7407 16.204C18.8688 16.1089 19.447 15.8028 19.3048 15.639H19.0233C19.2634 15.3226 19.6504 14.7848 19.8698 14.4609C21.1845 12.5229 21.289 10.276 22.1309 8.10537C22.1601 8.03004 22.2674 7.95658 22.225 7.82286C22.6008 7.44618 22.8767 5.2605 23.5914 4.62203C24.3062 3.98356 25.2262 4.53633 25.2187 5.42153C25.2064 6.90282 23.9144 9.57348 23.2157 10.9324C22.7552 11.827 22.2721 12.7206 21.661 13.5211C21.6544 13.5983 21.7919 13.5757 21.8484 13.5672V13.7556C21.8267 13.7866 21.7363 13.8064 21.6788 13.9147C21.612 14.0409 21.6101 14.1916 21.5658 14.3206L21.4717 14.5089C21.402 14.7538 21.4161 15.0297 21.3775 15.2623C21.3587 15.3753 21.0978 15.5881 21.4717 15.5448C21.4858 15.4864 21.4557 15.3979 21.4717 15.3565C21.5913 15.0626 22.5057 13.7499 22.742 13.4721C23.097 13.054 23.6545 12.4504 24.2563 12.8082C24.858 13.1661 24.4352 14.6276 24.3909 15.2623C24.2977 15.2877 24.3043 15.3706 24.2968 15.4506C24.2902 15.5175 24.2817 15.6898 24.2968 15.7331C24.3834 15.9789 24.4531 15.7595 24.4851 15.7331C24.6471 15.5985 24.8185 15.2915 24.9381 15.1031C25.4579 14.2839 26.2273 12.457 26.7885 11.8693C27.3498 11.2817 27.9515 11.5774 27.6869 12.343C27.6803 12.3628 27.5259 12.3835 27.6031 12.5219C27.6539 12.553 27.7679 12.5172 27.7811 12.5314C27.7961 12.5474 27.7453 12.6867 27.8931 12.7508C28.1417 12.8581 28.3922 12.7828 28.6286 12.8139C28.6389 12.8148 28.7218 12.9448 28.8169 12.908C28.8047 13.0926 29.0401 13.1981 28.993 13.4024C28.9572 13.554 28.5928 14.1219 28.492 14.4185C28.4176 14.637 28.3696 15.2256 28.3461 15.2613C28.3037 15.3254 28.0607 15.0918 28.2519 15.5439C28.2792 15.6088 28.1803 15.8056 28.3903 15.7294C28.558 15.6691 28.7209 15.3913 28.7435 15.38C28.784 15.3602 28.8988 15.4582 28.9073 15.4487C28.9337 15.4195 29.106 14.9996 29.2887 14.7905C29.5307 14.5136 29.9931 14.3413 29.9479 13.8488C30.0957 13.6934 30.0609 13.6821 30.1362 13.5663C30.3067 13.3045 30.3076 13.2066 30.4188 13.0013C30.5996 12.6679 30.7239 12.2969 31.0327 12.0605C31.3755 12.2385 31.1514 12.4155 31.643 12.2488L30.8896 15.1662C31.0836 15.3131 32.2052 14.1822 32.208 13.943C32.3116 13.926 32.3539 13.7848 32.3963 13.7546C32.7391 13.5107 32.6317 13.5748 32.8822 13.248C33.9737 11.826 34.6008 11.1838 36.4456 10.8354C36.5916 10.9992 36.779 11.1367 37.0106 11.1179C37.1802 11.7149 37.0653 11.487 36.8741 11.8797C36.6829 12.2724 36.925 12.1971 36.3515 12.4362C36.3063 12.4551 36.2083 12.4174 36.1631 12.4362V12.3421C36.3081 12.3364 36.3081 12.0652 36.1631 12.0596C35.9183 11.8194 34.162 13.0286 34.0923 13.4269C34.0791 13.5032 34.0933 13.5842 34.0904 13.6605C34.7101 13.6294 35.292 13.8761 35.8382 14.1266C35.9117 14.1285 35.8646 13.9571 35.8797 13.943C36.1989 13.6614 39.4967 12.4541 40.1173 12.2479C40.2313 12.2102 40.3744 12.1792 40.494 12.1537C40.5891 12.134 40.7228 12.1923 40.7765 12.0596C41.0854 12.0784 41.4074 12.0596 41.7182 12.0596H41.9065C41.9254 12.0765 42.3096 12.2244 42.3774 12.2479C42.4621 12.6058 42.287 12.5992 42.0949 12.8129C39.9939 13.1463 38.1162 13.6944 36.229 14.6907C35.9701 14.8978 36.117 15.3743 36.0463 15.6625C35.9851 15.9102 35.7657 16.2106 35.5972 16.3914C35.519 16.4752 35.3975 16.6023 35.3146 16.6739C34.6244 17.2766 33.5103 18.0356 32.5837 18.0864C32.5564 18.0883 32.2861 17.9885 32.207 17.9923C32.2033 17.7399 32.0611 17.5751 32.1336 17.2135C32.2042 16.8613 32.9077 16.0844 33.1949 15.8264C33.6111 15.4525 34.1196 15.1785 34.5603 14.8366L33.0536 14.3187C33.0791 14.1803 33.0367 13.9966 33.0536 13.8479C32.8992 13.668 32.304 14.5259 32.9604 14.4129C32.7824 14.8404 32.6383 14.7189 32.5837 14.7896C32.1882 14.5777 32.0055 14.8272 32.3954 15.0721C32.3351 15.1389 32.2918 15.3226 32.1148 15.4977C31.6204 15.9865 30.8001 16.6296 30.1805 16.0156C29.9338 15.9497 30.0289 15.2613 29.8066 15.3555C29.4234 15.5175 29.0514 16.6852 28.1088 16.6767C27.2933 16.6692 27.2735 16.0288 27.216 15.4487C27.3432 15.4045 27.3008 15.267 27.3102 15.1662C27.3507 14.75 27.4957 14.459 27.4985 14.0362L27.6869 13.8488C27.6247 13.8431 27.5607 13.8535 27.4985 13.8488C27.3356 13.8337 26.7151 13.7537 26.651 13.7951C26.4297 13.9373 25.763 15.4836 25.5586 15.816C25.1603 16.462 24.5039 17.4828 23.6385 17.0506C23.6357 16.9611 23.4106 16.8038 23.356 16.6739C23.1507 16.187 23.389 15.332 23.3551 14.7905C22.9991 14.8809 23.0518 15.0193 23.0726 15.3555C22.92 15.4082 23.0349 14.9958 22.8409 15.2642C22.6149 15.5778 22.4313 16.0533 22.226 16.3914C22.1695 16.4846 22.0433 16.5957 21.9435 16.7681C21.7269 17.141 21.0554 18.5733 20.8615 18.7466C20.6232 18.9594 19.9358 18.8662 19.8717 18.5102C19.7116 17.6278 20.0959 16.7021 20.1081 15.8264C19.3152 16.9168 18.5731 18.1712 17.6126 19.1223C17.5533 19.1807 17.4779 19.2607 17.4243 19.3106C16.6718 20.0028 15.4326 20.7336 14.4108 20.8174C14.2149 20.8334 13.9484 20.8324 13.7516 20.8174C13.6593 20.8108 13.5567 20.8306 13.4691 20.8174C13.4465 20.8136 13.3608 20.743 13.2808 20.7232C12.0632 20.4162 11.4576 19.5451 11.209 18.3689C11.2203 18.0139 11.388 18.1571 11.3974 17.7098C11.4096 17.124 11.2637 16.85 11.3974 16.203C11.5433 15.4977 11.3042 16.1032 11.209 15.638C11.2269 15.5213 11.1893 15.3753 11.209 15.2613L11.3032 15.1672C11.3145 15.1088 11.2919 15.0363 11.3032 14.9788C11.4642 15.1493 11.7128 15.0645 11.5838 14.8856C11.5735 14.8715 11.323 14.9195 11.3974 14.6963C11.4341 14.5409 11.4501 14.3827 11.4915 14.2255H11.5857C11.8277 14.3187 11.9558 13.7151 11.6799 13.6605C11.6893 13.6322 11.6705 13.5945 11.6799 13.5663C12.0547 13.6096 11.9031 13.5531 11.9728 13.345C12.1008 12.9636 12.2807 12.6331 12.4116 12.2743C12.4728 12.1076 12.6319 11.8232 12.4332 11.6829C12.7638 10.9568 13.1179 10.1715 13.5633 9.51698C13.7563 9.52357 13.8505 9.42281 13.8458 9.23447C13.8929 9.17138 13.9211 9.08851 14.0341 8.95196C14.2357 8.709 14.2018 8.66757 14.3166 8.48111C15.2951 6.89435 17.4996 4.2962 19.4932 4.15118ZM24.1065 5.94041C23.8561 5.89332 23.9427 5.99314 23.8768 6.12875C23.3796 7.14578 23.0933 8.273 22.6949 9.32864C22.8899 9.37008 22.9144 9.23447 22.9963 9.11299C23.5604 8.273 23.9031 6.92919 24.1075 5.94041H24.1065ZM32.5818 14.6031C32.6496 14.4713 32.5225 14.3517 32.4895 14.4157C32.4217 14.5475 32.5489 14.6671 32.5818 14.6031ZM11.7006 14.6954C11.7006 14.6313 11.6488 14.5796 11.5848 14.5796C11.5207 14.5796 11.4689 14.6313 11.4689 14.6954C11.4689 14.7594 11.5207 14.8112 11.5848 14.8112C11.6488 14.8112 11.7006 14.7594 11.7006 14.6954ZM11.4868 15.5448C11.5019 15.5326 11.5754 15.2406 11.582 15.1691C11.4737 15.2284 11.2119 15.4563 11.3004 15.5448C11.3588 15.5391 11.4689 15.5599 11.4868 15.5448ZM34.7487 15.8292C34.0688 15.88 33.6554 16.5016 33.242 16.9573C33.5461 17.0741 34.8683 15.9252 34.7487 15.8292Z" fill="#577896"/>
      <path d="M32.489 9.4247C32.8111 9.55936 33.1482 9.71945 33.0898 10.1602C33.0842 10.2044 32.6576 10.8956 32.6265 10.9277C31.8025 11.7676 31.2874 10.4926 32.0182 9.61304C32.0596 9.56313 32.1867 9.53111 32.2065 9.4247C32.2329 9.43506 32.2715 9.41528 32.3007 9.4247C32.3515 9.44165 32.4447 9.40681 32.489 9.4247Z" fill="#577896"/>
      <path d="M7.37242 5.29297H8.02902L7.04132 8.65934C6.87858 9.21562 6.54748 9.39913 6.08169 9.39913H5.55978V8.83712H6.01996C6.28372 8.83712 6.40157 8.75109 6.48013 8.47009L6.55309 8.20628C6.16026 8.20628 6.00874 8.05717 5.81793 7.47795L5.09961 5.29297H5.77865L6.40718 7.24282C6.49697 7.51236 6.53625 7.62706 6.64849 7.62706H6.71583L7.37242 5.29297Z" fill="#577896"/>
      <path d="M2.68465 4.12305V5.70587C2.86984 5.40766 3.16727 5.22988 3.59939 5.22988C4.29526 5.22988 4.83962 5.68867 4.83962 6.76682C4.83962 7.78189 4.34577 8.29803 3.59939 8.29803C3.16727 8.29803 2.86984 8.12025 2.68465 7.82204V8.24068H2V4.12305H2.68465ZM3.40858 7.74175C3.90804 7.74175 4.15497 7.42633 4.15497 6.76682C4.15497 6.10158 3.90804 5.78616 3.40858 5.78616C2.92035 5.78616 2.68465 6.10158 2.68465 6.76682C2.68465 7.42633 2.92035 7.74175 3.40858 7.74175Z" fill="#577896"/>
      <g clip-path="url(#clip0_8383_10754)">
      <path d="M96.0583 4.50928V20.7581H94.0037V19.2872C93.2877 19.9301 92.479 20.4678 91.5397 20.7379C87.0591 22.0294 82.7564 18.3676 83.3881 13.7982C84.0829 8.76542 90.2484 6.54072 94.0037 10.0422V4.50928H96.0583ZM94.0964 14.6702C94.0964 12.2815 92.1381 10.3453 89.7223 10.3453C87.3065 10.3453 85.3482 12.2815 85.3482 14.6702C85.3482 17.0588 87.3065 18.995 89.7223 18.995C92.1381 18.995 94.0964 17.0588 94.0964 14.6702Z" fill="white"/>
      <path d="M110.646 14.6694C110.646 18.1645 107.78 20.9973 104.246 20.9973C100.711 20.9973 97.8457 18.1645 97.8457 14.6694C97.8457 11.1744 100.711 8.34155 104.246 8.34155C107.78 8.34155 110.646 11.1744 110.646 14.6694ZM108.619 14.6685C108.619 12.2799 106.661 10.3446 104.246 10.3446C101.831 10.3446 99.8725 12.2808 99.8725 14.6685C99.8725 17.0563 101.831 18.9924 104.246 18.9924C106.661 18.9924 108.619 17.0563 108.619 14.6685Z" fill="white"/>
      <path d="M70.6293 15.6448L75.9778 10.8134C77.0607 9.70796 77.3682 8.33412 76.5373 6.9667C74.9385 4.33259 70.7941 5.52875 70.8414 8.57134H68.2912C68.2662 5.84565 70.4106 3.39106 73.1516 3.04668C76.9403 2.57042 80.124 5.82824 79.4645 9.56874C78.9976 12.2175 76.1686 13.8441 74.4179 15.6448H70.6283H70.6293Z" fill="white"/>
      <path d="M52 18.2359L60.7898 3.04224L63.05 4.26403L56.3917 15.7145H60.0043V18.2359H52Z" fill="white"/>
      <path d="M116.175 8.5715H119.999V10.602H116.175V20.7574H114.12V10.602H111.074V8.5715H114.12V4.50952H116.068L116.175 4.61393V8.5715Z" fill="white"/>
      <path d="M80.4764 18.2358H67.7266V20.7573H80.4764V18.2358Z" fill="white"/>
      <path d="M65.1038 10.6018H62.625V20.7572H65.1038V10.6018Z" fill="white"/>
      </g>
      <defs>
      <clipPath id="clip0_8383_10754">
      <rect width="68" height="18" fill="white" transform="translate(52 3)"/>
      </clipPath>
      </defs>
    </svg>
  </div>
</div>

<script>
let socket = null;
let frameData = [];
let scanConfirmed = false;
let screenInfo = null; // Store screen info from Grid Generator app

// Debug logging helper
function addDebug(message) {
  const debug = document.getElementById('debug');
  const timestamp = new Date().toLocaleTimeString();
  debug.innerHTML = `${timestamp} ${message}<br>${debug.innerHTML}`;
}

// WebSocket setup
function connectWebSocket() {
  try {
    // Close existing socket if any
    if (socket) {
      socket.close();
    }
    
    addDebug('Creating new WebSocket connection...');
    socket = new WebSocket('ws://localhost:8080');
    
    socket.addEventListener('open', () => {
      updateConnectionStatus(true);
      addDebug('Connected to Electron app');
      document.getElementById('sendButton').disabled = false;
      
      // Request screen info as soon as we connect
      addDebug('Immediately requesting screen info after connection...');
      requestScreenInfo();
      
      // Request again after a short delay in case the first request is sent too early
      setTimeout(() => {
        addDebug('Sending follow-up screen info request...');
        requestScreenInfo();
      }, 1000);
    });

    socket.addEventListener('message', (event) => {
      try {
        addDebug('Received WebSocket message: ' + event.data.substring(0, 100) + (event.data.length > 100 ? '...' : ''));
        console.log('WebSocket message received:', event.data); // Log to browser console as well
        
        const message = JSON.parse(event.data);
        addDebug('Message type: ' + message.type);
        
        // Handle different message types
        if (message.type === 'screen-info') {
          // Store screen info
          screenInfo = message;
          
          // Special case for Samsung Serif 55" - ensure correct DPI
          if (Math.abs(screenInfo.monitorWidth - 47.95) < 1 && Math.abs(screenInfo.monitorHeight - 26.97) < 1) {
            addDebug('Detected Samsung Serif 55" display - Setting correct DPI to 80');
            screenInfo.dpi = 80; // Override with correct DPI value
          }
          
          addDebug(`Received screen info: 
Monitor: ${screenInfo.monitorWidth}" × ${screenInfo.monitorHeight}"
Grid spacing: ${screenInfo.gridSpacingX?.toFixed(2) || 'undefined'}px/in × ${screenInfo.gridSpacingY?.toFixed(2) || 'undefined'}px/in
DPI: ${screenInfo.dpi || 'undefined'}`);
          
          // Update UI with screen info
          updateScreenInfoDisplay();
          
          // Forward to plugin code
          parent.postMessage({ 
            pluginMessage: { 
              type: 'screen-info',
              screenInfo
            }
          }, '*');
          addDebug('Forwarded screen info to plugin code');
        }
      } catch (error) {
        addDebug(`Error parsing WebSocket message: ${error.message}`);
        console.error('Error parsing message:', error, 'Raw message:', event.data);
      }
    });

    socket.addEventListener('error', (error) => {
      updateConnectionStatus(false);
      addDebug('WebSocket error: ' + error);
      document.getElementById('sendButton').disabled = false; // Enable the button so users can still click it to see the "NOT CONNECTED" message
      socket = null; // Set socket to null on error
    });

    socket.addEventListener('close', () => {
      updateConnectionStatus(false);
      addDebug('Disconnected from Electron app');
      document.getElementById('sendButton').disabled = false; // Enable the button so users can still click it
      socket = null; // Set socket to null on close
    });

  } catch (error) {
    updateConnectionStatus(false);
    addDebug('Connection error: ' + error.message);
    document.getElementById('sendButton').disabled = false; // Enable the button so users can still click it
    socket = null; // Make sure socket is null if connection fails
  }
}

// Update frame list in UI
function updateFrameList(frames) {
  frameData = frames;
  const frameList = document.getElementById('frameList');
  
  if (frames.length === 0) {
    frameList.innerHTML = '<div class="no-frames">No frames found with the naming format name#widthxheight or name#CODE#.<br><br>Select frames then <span style="color: #77c2ea">Refresh</span>.</div>';
    return;
  }
  
  frameList.innerHTML = frames.map(frame => `
    <div class="frame-item">
      <input type="checkbox" id="${frame.originalName}" value="${frame.originalName}">
      <label for="${frame.originalName}">
        ${frame.name} (${frame.widthInches}"x${frame.heightInches}")
      </label>
    </div>
  `).join('');
}

// Show confirmation dialog
function showConfirmation(message, count) {
  const frameList = document.getElementById('frameList');
  frameList.innerHTML = `
    <div class="confirmation">
      <p>${message}</p>
      <div class="confirmation-buttons">
        <button id="confirmYes" class="confirm-button">Yes, Scan All Frames</button>
        <button id="confirmNo" class="confirm-button secondary">Cancel</button>
      </div>
    </div>
  `;
  
  // Add event listeners
  document.getElementById('confirmYes').addEventListener('click', () => {
    scanConfirmed = true;
    addDebug(`User confirmed scanning ${count} frames`);
    parent.postMessage({ 
      pluginMessage: { 
        type: 'scan-frames',
        confirmScan: true
      }
    }, '*');
  });
  
  document.getElementById('confirmNo').addEventListener('click', () => {
    scanConfirmed = false;
    addDebug('User cancelled frame scanning');
    frameList.innerHTML = '<div class="no-frames">Scanning cancelled. Click the refresh icon to try again.</div>';
  });
}

// Show loading state
function showLoading(message) {
  const frameList = document.getElementById('frameList');
  frameList.innerHTML = `<div class="loading"><div class="spinner"></div><p>${message}</p></div>`;
}

// Add click handler for send button
document.getElementById('castButton').addEventListener('click', () => {
  console.log('Button clicked!'); // Debug log
  addDebug('Button clicked!'); // Debug log in UI
  
  // First check if WebSocket is connected
  if (!socket || socket.readyState !== WebSocket.OPEN) {
    // WebSocket not connected - show error in RED
    const button = document.getElementById('castButton');
    button.textContent = 'NOT CONNECTED';
    button.classList.add('error');
    button.classList.add('flash-error');
    
    addDebug('WebSocket not connected. Please check your connection.');
    
    // Reset button after 2 seconds
    setTimeout(() => {
      button.textContent = 'SEND TO GRID';
      button.classList.remove('error', 'flash-error');
    }, 2000);
    
    return; // Stop execution
  }
  
  // Now check if frames are selected
  const selectedFrames = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
    .map(cb => cb.value);

  console.log('Selected frames:', selectedFrames); // Debug log
  addDebug(`Selected frames: ${selectedFrames.length}`); // Debug log in UI

  if (selectedFrames.length > 0) {
    try {
      // Update button state
      const button = document.getElementById('castButton');
      button.textContent = 'CONNECTING...';
      button.classList.add('sending');
      button.disabled = true;
      
      addDebug(`Connecting to Electron app...`);
      
      // WebSocket is already checked, proceed with export
      continueWithExport();
      
      function continueWithExport() {
        button.textContent = 'CREATING PNGS...';
        addDebug(`Sending ${selectedFrames.length} frames to plugin for export...`);
        
        // Send to plugin for export
        parent.postMessage({ 
          pluginMessage: { 
            type: 'export-frames', 
            frameNames: selectedFrames 
          }
        }, '*');
      }
      
    } catch (error) {
      addDebug(`Error: ${error.message}`);
      button.textContent = 'ERROR!';
      button.classList.remove('sending');
      button.classList.add('error');
      
      setTimeout(() => {
        button.textContent = 'SEND TO GRID';
        button.classList.remove('error');
        button.disabled = false;
      }, 2000);
    }
  } else {
    // No frames selected - show ORANGE warning
    const button = document.getElementById('castButton');
    
    // Store original text and background to restore later
    const originalText = button.textContent;
    
    // Set warning text 
    button.textContent = 'SELECT A FRAME';
    button.classList.add('flash-warning');
    
    // Log the error
    addDebug('No frames selected! Please select frames to send.');
    
    // Reset after animation completes (about 1.6 seconds)
    setTimeout(() => {
      button.textContent = originalText;
      button.classList.remove('flash-warning');
    }, 1600);
  }
});

// Add click handler for resize button
document.getElementById('resizeButton').addEventListener('click', () => {
    parent.postMessage({ pluginMessage: { type: 'resize-frame' } }, '*');
});

// Add click handler for SEND LIVE button
document.getElementById('sendLiveButton').addEventListener('click', () => {
  if (!socket || socket.readyState !== WebSocket.OPEN) {
    const btn = document.getElementById('sendLiveButton');
    btn.textContent = 'NOT CONNECTED';
    btn.classList.add('error', 'flash-error');
    setTimeout(() => {
      btn.textContent = 'SEND LIVE';
      btn.classList.remove('error', 'flash-error');
    }, 1600);
    addDebug('WebSocket not connected.');
    return;
  }
  parent.postMessage({ pluginMessage: { type: 'send-live' } }, '*');
});

// Add click handler for NAME FRAME (Add Size) button
document.getElementById('nameFrameButton').addEventListener('click', () => {
  parent.postMessage({ pluginMessage: { type: 'add-size' } }, '*');
});

// Listen for messages from the plugin
window.onmessage = async (event) => {
  const message = event.data.pluginMessage;
  
  if (!message) return;
  
  if (message.type === 'init-ui') {
    // Initial load - just show empty state
    updateFrameList([]);
    addDebug('Plugin loaded. Select frames in Figma and click refresh to scan them.');
  }
  else if (message.type === 'selection-empty') {
    // No frames selected
    const frameList = document.getElementById('frameList');
    frameList.innerHTML = `<div class="no-frames">${message.message}</div>`;
    addDebug('No frames selected. Please select frames in Figma.');
  }
  else if (message.type === 'no-matching-frames') {
    // No matching frames
    const frameList = document.getElementById('frameList');
    frameList.innerHTML = `<div class="no-frames">${message.message}<br><br>Make sure selected frames follow the naming format: name#widthxheight or name#CODE#</div>`;
    addDebug('No matching frames found in selection.');
  }
  else if (message.type === 'confirm-scan') {
    // Show confirmation for many frames
    showConfirmation(message.message, message.count);
  }
  else if (message.type === 'scan-started') {
    // Show loading state
    showLoading('Scanning selected frames...');
    addDebug('Scanning frames...');
  }
  else if (message.type === 'update-frame-list') {
    // Update the frame list with new data
    updateFrameList(message.frames);
    addDebug(`Found ${message.frames.length} matching frames in selection`);
  }
  else if (message.type === 'export-started') {
    const button = document.getElementById('castButton');
    button.textContent = 'Creating PNGs...';
    addDebug(`Starting export of ${message.count} frames...`);
  }
  else if (message.type === 'export-progress') {
    const button = document.getElementById('castButton');
    button.textContent = `Creating PNGs (${message.current}/${message.total})`;
    button.classList.add('sending'); // Make sure the sending class is applied
    addDebug(`Exported ${message.current} of ${message.total}: ${message.frameName}`);
  }
  else if (message.type === 'send-to-electron' && message.frames) {
    const button = document.getElementById('castButton');
    
    if (socket && socket.readyState === WebSocket.OPEN) {
      try {
        button.textContent = 'SENDING TO GRID...';
        button.classList.add('sending'); // Ensure sending class is applied
        addDebug(`Exporting complete. Sending ${message.frames.length} frames to Electron app...`);
        
        // Send each frame's data separately to handle large files better
        for (let i = 0; i < message.frames.length; i++) {
          const frame = message.frames[i];
          
          // Log the received frame data to help debug
          addDebug(`Frame data received: ${JSON.stringify({
            name: frame.name,
            widthInches: frame.widthInches,
            heightInches: frame.heightInches,
            originalName: frame.originalName
          })}`);
          
          // Include screen info dimensions if available
          const frameData = {
            name: frame.name,
            widthInches: frame.widthInches,
            heightInches: frame.heightInches,
            originalName: frame.originalName,
            imageBytes: Array.from(frame.imageBytes),
            // Add metadata to indicate image is high-res but should be displayed at original dimensions
            isHighRes: true,
            resolutionFactor: 2
          };
          
          // Add screen info metadata if available
          if (screenInfo) {
            frameData.screenInfo = {
              monitorWidth: screenInfo.monitorWidth,
              monitorHeight: screenInfo.monitorHeight,
              pixelsPerInch: screenInfo.pixelsPerInch,
              gridSpacingX: screenInfo.gridSpacingX,
              gridSpacingY: screenInfo.gridSpacingY,
              dpi: screenInfo.dpi
            };
            
            addDebug(`Frame ${i+1}/${message.frames.length} includes screen dimensions: ${screenInfo.monitorWidth}"×${screenInfo.monitorHeight}", grid spacing: ${screenInfo.gridSpacingX.toFixed(2)}×${screenInfo.gridSpacingY.toFixed(2)}px/in, DPI: ${screenInfo.dpi}`);
          } else {
            addDebug(`Warning: Frame ${i+1}/${message.frames.length} sent without screen info`);
          }
          
          socket.send(JSON.stringify({
            type: 'frame-data',
            frame: frameData
          }));
          
          addDebug(`Sent frame ${i+1}/${message.frames.length}: "${frame.name}" to Electron app`);
        }
        
        // Show success state
        button.textContent = 'SUCCESS!';
        button.classList.remove('sending');
        button.classList.add('success');
        addDebug('All frames successfully sent to Electron app!');
        
        // Reset button after 2 seconds
        setTimeout(() => {
          button.textContent = 'SEND TO GRID';
          button.classList.remove('success');
          button.disabled = false;
        }, 2000);
        
      } catch (error) {
        addDebug(`Error sending frames: ${error.message}`);
        button.textContent = 'ERROR!';
        button.classList.remove('sending');
        button.classList.add('error');
        
        // Reset button after 2 seconds
        setTimeout(() => {
          button.textContent = 'SEND TO GRID';
          button.classList.remove('error');
          button.disabled = false;
        }, 2000);
      }
    } else {
      addDebug('WebSocket not connected - cannot send frames');
      button.textContent = 'NOT CONNECTED';
      button.classList.remove('sending');
      button.classList.add('error', 'flash-error');
      
      // Reset button after 2 seconds
      setTimeout(() => {
        button.textContent = 'SEND TO GRID';
        button.classList.remove('error', 'flash-error');
        button.disabled = false;
      }, 2000);
    }
  } else if (message.type === 'send-resize-to-electron' && message.frame) {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'resize-frame',
            frame: message.frame
        }));
        addDebug(`Sent resize command for frame "${message.frame.name}"`);
    } else {
        addDebug('WebSocket not connected - cannot send resize command');
    }
  }
  else if (message.type === 'send-live-to-electron' && message.frame) {
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ type: 'live-frame', frame: message.frame }));
      addDebug(`Sent live frame metadata for "${message.frame.name}"`);
    } else {
      addDebug('WebSocket not connected - cannot send live frame');
    }
  }
  else if (message.type === 'live-selection') {
    const btn = document.getElementById('sendLiveButton');
    if (message.liveSelected) {
      btn.classList.add('live-active');
    } else {
      btn.classList.remove('live-active');
    }
  }
  else if (message.type === 'get-screen-info') {
    // Plugin is requesting screen info - if we have it, send it back
    if (screenInfo) {
      parent.postMessage({
        pluginMessage: {
          type: 'screen-info',
          screenInfo
        }
      }, '*');
      
      addDebug('Sent screen info to plugin');
    } else {
      // Don't have screen info yet, try to request it
      requestScreenInfo();
      addDebug('No screen info available - requested from Grid Generator');
    }
  }
  else if (message.type === 'request-screen-info') {
    // Explicit request to get fresh screen info
    requestScreenInfo();
    addDebug('Requested fresh screen info from Grid Generator');
  }
};

function handleFileUrl() {
  const url = document.getElementById('figmaUrl').value;
  const fileKey = extractFileKey(url);
  
  if (fileKey) {
    parent.postMessage({
      pluginMessage: {
        type: 'set-file-key',
        fileKey: fileKey
      }
    }, '*');
    showStatus('File key set: ' + fileKey);
  } else {
    showStatus('Invalid Figma URL', false);
  }
}

function extractFileKey(url) {
  const match = url.match(/figma\.com\/(file|design)\/([^\/?]+)/);
  return match ? match[2] : null;
}

function showStatus(message, success = true) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = success ? 'success' : 'error';
  addDebug('Status: ' + message);
}

// Start WebSocket connection
connectWebSocket();

// Initialize screen info display
updateScreenInfoDisplay();

// Update the connection status light
function updateConnectionStatus(connected) {
  const light = document.querySelector('.status-light');
  const text = document.querySelector('.connection-status span');
  if (connected) {
    light.classList.remove('disconnected');
    text.textContent = 'CONNECTED';
  } else {
    light.classList.add('disconnected');
    text.textContent = 'DISCONNECTED';
  }
}

// Add click handler for connection status
document.querySelector('.connection-status').addEventListener('click', () => {
  addDebug('Manual reconnection attempt...');
  connectWebSocket();
});

// Add this to your existing JavaScript
document.querySelector('.clear-console').addEventListener('click', () => {
  document.getElementById('debug').innerHTML = '';
  addDebug('Console cleared');
});

// Add this to your existing JavaScript
document.querySelector('.refresh-icon').addEventListener('click', () => {
  // Add a small rotation animation during refresh
  const refreshIcon = document.querySelector('.refresh-icon');
  refreshIcon.style.transform = 'rotate(360deg)';
  
  // Reset the confirmation flag
  scanConfirmed = false;
  
  // Send message to the plugin to scan for frames
  parent.postMessage({ pluginMessage: { type: 'scan-frames' } }, '*');
  
  // Reset the rotation after animation
  setTimeout(() => {
    refreshIcon.style.transform = 'rotate(0deg)';
  }, 300);
});

// Request screen info from Grid Generator app
function requestScreenInfo() {
  if (socket && socket.readyState === WebSocket.OPEN) {
    const message = JSON.stringify({ type: 'get-screen-info' });
    addDebug('Requesting screen info from Grid Generator app... Sending: ' + message);
    
    try {
      socket.send(message);
    } catch (error) {
      addDebug('Error sending screen info request: ' + error.message);
    }
  } else {
    const state = socket ? ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'][socket.readyState] : 'null';
    addDebug(`Cannot request screen info - WebSocket not connected (state: ${state})`);
  }
}

// Update the screen info display in UI
function updateScreenInfoDisplay() {
  const infoElement = document.querySelector('.grid-info-content');
  if (!infoElement) {
    console.error('Error: Could not find .grid-info-content element');
    return;
  }
  
  // If we haven't received screen info yet but we're connected, show "Waiting for data"
  if (!screenInfo) {
    if (socket && socket.readyState === WebSocket.OPEN) {
      infoElement.innerHTML = '<div class="loading-info">Waiting for data from Grid Generator...</div>';
      console.log('No screen info available yet, showing waiting message');
      // Try requesting again
      requestScreenInfo();
    } else {
      infoElement.innerHTML = '<div class="connect-prompt">Connect to Grid App</div>';
      console.log('Not connected to Grid Generator app');
    }
    return;
  }
  
  console.log('Updating screen info display with data:', screenInfo);
  
  // We have screen info, format and display it
  try {
    // Only use the values directly from screenInfo, no defaults
    const monitorWidth = screenInfo.monitorWidth;
    const monitorHeight = screenInfo.monitorHeight;
    const gridSpacingX = screenInfo.gridSpacingX;
    const gridSpacingY = screenInfo.gridSpacingY;
    const dpi = screenInfo.dpi;
    
    // Only display values that are actually defined
    let htmlContent = '';
    
    if (monitorWidth !== undefined && monitorHeight !== undefined) {
      htmlContent += `<div>MONITOR: ${monitorWidth.toFixed(1)}" × ${monitorHeight.toFixed(1)}"</div>`;
    } else {
      htmlContent += `<div>MONITOR: WAITING FOR DATA...</div>`;
    }
    
    if (gridSpacingX !== undefined && gridSpacingY !== undefined) {
      htmlContent += `<div>GRID SPACING: ${gridSpacingX.toFixed(2)}PX/IN × ${gridSpacingY.toFixed(2)}PX/IN</div>`;
    } else {
      htmlContent += `<div>GRID SPACING: WAITING FOR DATA...</div>`;
    }
    
    if (dpi !== undefined) {
      htmlContent += `<div>DPI: ${dpi.toFixed(0)}</div>`;
    } else {
      htmlContent += `<div>DPI: WAITING FOR DATA...</div>`;
    }
    
    infoElement.innerHTML = htmlContent;
    console.log('Screen info display updated successfully');
  } catch (error) {
    console.error('Error updating screen info display:', error);
    // Show error state
    infoElement.innerHTML = '<div class="error-info">Error displaying Grid Generator info</div>';
  }
}

// Add this near the end of your script section
document.querySelector('.footer').addEventListener('click', () => {
  const console = document.querySelector('.console');
  console.classList.toggle('visible');
});
</script> 