<!-- App by Chris Jacobs -->
<!DOCTYPE html>
<html>
<head>
    <title>Grid 2.0</title>
    <link rel="stylesheet" href="css/grid-gen.css">
</head>
<body>
    <div id="splash-screen">
        <img src="assets/grid-splash.png" alt="Grid 2.0">
    </div>
    <div id="setup-container">
        <div class="setup-content">
            <div class="h1-header">Select Monitor Size</div>
            <div class="input-flex">
            <input type="number" id="monitor-width" placeholder="W">
            <input type="number" id="monitor-height" placeholder="H">
            </div>
           <button onclick="initializeGrid()">
               <img src="assets/grid-go_white.svg" alt="Grid Icon" style="width: 20px; height: 20px; vertical-align: middle;"></button>
            
            <div class="divider"></div>
            <div class="h1-header">Presets</div>
            <div id="monitor-presets"></div>
        </div>
       
    </div>
    <div class="footer-credit" id="withlove">
        <svg width="124" height="26" viewBox="0 0 124 26" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.4656 20.8193C13.2791 21.325 13.3884 21.9691 13.3714 22.5143C13.3686 22.5972 13.4185 23.4843 13.184 23.1726C13.2113 22.358 13.104 21.5255 13.2773 20.7251C13.3573 20.7449 13.443 20.8155 13.4656 20.8193Z" fill="#577896"/>
            <path d="M27.8133 15.8039C27.6268 16.3096 27.736 16.9537 27.7191 17.4989C27.7163 17.5818 27.7662 18.4689 27.5317 18.1572C27.559 17.3426 27.4516 16.5102 27.6249 15.7097C27.705 15.7295 27.7906 15.8001 27.8133 15.8039Z" fill="#577896"/>
            <path d="M36.0066 15.0505C35.8202 15.5562 35.9294 16.2003 35.9124 16.7455C35.9096 16.8284 35.9595 17.7155 35.725 17.4038C35.7524 16.5892 35.645 15.7567 35.8183 14.9563C35.8983 14.9761 35.984 15.0467 36.0066 15.0505Z" fill="#577896"/>
            <path d="M14.4072 20.8193V20.9135C14.1172 20.8419 14.2283 21.132 14.2189 21.3844C14.2085 21.6697 14.1502 22.117 14.3131 22.3261C14.2839 22.4946 14.3941 22.6886 14.2189 22.7969C14.2566 22.5304 14.0871 22.5304 14.1247 22.7969C13.9722 22.7056 14.0409 22.5737 14.0306 22.4202C14.024 22.327 14.0334 22.2319 14.0306 22.1377C14.0221 21.8872 14.0409 21.6348 14.0306 21.3844C14.0164 21.034 14.1445 20.9493 13.748 20.8193C13.9449 20.8344 14.2114 20.8353 14.4072 20.8193Z" fill="#577896"/>
            <path d="M14.4081 21.3843C14.41 21.7826 14.3761 21.9653 14.314 22.326C14.1511 22.1169 14.2094 21.6696 14.2198 21.3843H14.4081Z" fill="#577896"/>
            <path d="M19.4932 4.15118C19.6128 4.1427 19.7493 4.14459 19.8698 4.15118C21.0432 4.21804 21.3229 4.94032 21.2824 6.03458C21.1647 6.07978 21.1854 6.2135 21.1882 6.31709C21.2221 7.5526 20.3755 8.9981 19.6815 9.98971C19.6627 10.0161 19.5977 10.0387 19.5873 10.0839H19.4932L19.3048 9.98971C19.2408 9.97653 18.8538 9.97747 18.834 9.98971C18.9922 9.80796 18.8114 9.37007 18.8509 9.11958C18.9338 8.60071 19.6052 7.5008 19.803 6.86139C20.2333 5.46862 20.4386 4.59001 18.7398 5.46862C18.269 5.71157 18.2002 5.76054 17.8923 6.12781C17.8668 6.15794 17.6653 6.09202 17.6098 6.50449H17.5156C17.5109 6.43103 17.5523 6.31426 17.4685 6.3152C17.3828 6.31426 17.4252 6.43951 17.4214 6.50449C17.3395 6.50354 17.2934 6.5591 17.2331 6.59866C17.0645 6.70883 17.0551 6.77946 16.9506 6.88116C16.702 7.12412 16.427 7.37556 16.1972 7.63452C15.6614 8.24004 15.0804 8.93878 14.6905 9.70626C14.6152 9.85411 14.5634 10.0227 14.5022 10.1771C14.0888 10.3042 14.231 10.6188 14.2197 10.648C14.1453 10.8335 13.9974 11.0472 13.9371 11.213C13.6857 11.1687 13.7441 11.2732 13.7488 11.4955C13.7319 11.5124 13.6848 11.8599 13.6546 11.9663C13.455 11.9428 13.4427 11.955 13.4663 12.1547C13.4427 12.1801 13.3053 12.7122 13.278 12.8139C13.1433 12.8553 13.0887 12.9579 13.0896 13.0964C13.083 13.103 13.0821 13.2433 13.0896 13.2847L12.9954 13.4731C12.9323 13.5211 12.518 14.8009 12.4756 14.9779C12.2167 16.0477 12.0575 17.9668 12.695 18.9067C13.4616 20.0376 14.9005 19.4971 15.8215 18.8407C15.9684 18.7362 16.2161 18.7381 16.1982 18.4641C16.2829 18.4245 16.5183 18.3115 16.5748 18.2757C16.7679 18.303 16.7905 18.2804 16.7632 18.0874C16.9383 17.9565 17.2924 17.674 17.4224 17.5224L17.849 17.3378L18.7407 16.204C18.8688 16.1089 19.447 15.8028 19.3048 15.639H19.0233C19.2634 15.3226 19.6504 14.7848 19.8698 14.4609C21.1845 12.5229 21.289 10.276 22.1309 8.10537C22.1601 8.03004 22.2674 7.95658 22.225 7.82286C22.6008 7.44618 22.8767 5.2605 23.5914 4.62203C24.3062 3.98356 25.2262 4.53633 25.2187 5.42153C25.2064 6.90282 23.9144 9.57348 23.2157 10.9324C22.7552 11.827 22.2721 12.7206 21.661 13.5211C21.6544 13.5983 21.7919 13.5757 21.8484 13.5672V13.7556C21.8267 13.7866 21.7363 13.8064 21.6788 13.9147C21.612 14.0409 21.6101 14.1916 21.5658 14.3206L21.4717 14.5089C21.402 14.7538 21.4161 15.0297 21.3775 15.2623C21.3587 15.3753 21.0978 15.5881 21.4717 15.5448C21.4858 15.4864 21.4557 15.3979 21.4717 15.3565C21.5913 15.0626 22.5057 13.7499 22.742 13.4721C23.097 13.054 23.6545 12.4504 24.2563 12.8082C24.858 13.1661 24.4352 14.6276 24.3909 15.2623C24.2977 15.2877 24.3043 15.3706 24.2968 15.4506C24.2902 15.5175 24.2817 15.6898 24.2968 15.7331C24.3834 15.9789 24.4531 15.7595 24.4851 15.7331C24.6471 15.5985 24.8185 15.2915 24.9381 15.1031C25.4579 14.2839 26.2273 12.457 26.7885 11.8693C27.3498 11.2817 27.9515 11.5774 27.6869 12.343C27.6803 12.3628 27.5259 12.3835 27.6031 12.5219C27.6539 12.553 27.7679 12.5172 27.7811 12.5314C27.7961 12.5474 27.7453 12.6867 27.8931 12.7508C28.1417 12.8581 28.3922 12.7828 28.6286 12.8139C28.6389 12.8148 28.7218 12.9448 28.8169 12.908C28.8047 13.0926 29.0401 13.1981 28.993 13.4024C28.9572 13.554 28.5928 14.1219 28.492 14.4185C28.4176 14.637 28.3696 15.2256 28.3461 15.2613C28.3037 15.3254 28.0607 15.0918 28.2519 15.5439C28.2792 15.6088 28.1803 15.8056 28.3903 15.7294C28.558 15.6691 28.7209 15.3913 28.7435 15.38C28.784 15.3602 28.8988 15.4582 28.9073 15.4487C28.9337 15.4195 29.106 14.9996 29.2887 14.7905C29.5307 14.5136 29.9931 14.3413 29.9479 13.8488C30.0957 13.6934 30.0609 13.6821 30.1362 13.5663C30.3067 13.3045 30.3076 13.2066 30.4188 13.0013C30.5996 12.6679 30.7239 12.2969 31.0327 12.0605C31.3755 12.2385 31.1514 12.4155 31.643 12.2488L30.8896 15.1662C31.0836 15.3131 32.2052 14.1822 32.208 13.943C32.3116 13.926 32.3539 13.7848 32.3963 13.7546C32.7391 13.5107 32.6317 13.5748 32.8822 13.248C33.9737 11.826 34.6008 11.1838 36.4456 10.8354C36.5916 10.9992 36.779 11.1367 37.0106 11.1179C37.1802 11.7149 37.0653 11.487 36.8741 11.8797C36.6829 12.2724 36.925 12.1971 36.3515 12.4362C36.3063 12.4551 36.2083 12.4174 36.1631 12.4362V12.3421C36.3081 12.3364 36.3081 12.0652 36.1631 12.0596C35.9183 11.8194 34.162 13.0286 34.0923 13.4269C34.0791 13.5032 34.0933 13.5842 34.0904 13.6605C34.7101 13.6294 35.292 13.8761 35.8382 14.1266C35.9117 14.1285 35.8646 13.9571 35.8797 13.943C36.1989 13.6614 39.4967 12.4541 40.1173 12.2479C40.2313 12.2102 40.3744 12.1792 40.494 12.1537C40.5891 12.134 40.7228 12.1923 40.7765 12.0596C41.0854 12.0784 41.4074 12.0596 41.7182 12.0596H41.9065C41.9254 12.0765 42.3096 12.2244 42.3774 12.2479C42.4621 12.6058 42.287 12.5992 42.0949 12.8129C39.9939 13.1463 38.1162 13.6944 36.229 14.6907C35.9701 14.8978 36.117 15.3743 36.0463 15.6625C35.9851 15.9102 35.7657 16.2106 35.5972 16.3914C35.519 16.4752 35.3975 16.6023 35.3146 16.6739C34.6244 17.2766 33.5103 18.0356 32.5837 18.0864C32.5564 18.0883 32.2861 17.9885 32.207 17.9923C32.2033 17.7399 32.0611 17.5751 32.1336 17.2135C32.2042 16.8613 32.9077 16.0844 33.1949 15.8264C33.6111 15.4525 34.1196 15.1785 34.5603 14.8366L33.0536 14.3187C33.0791 14.1803 33.0367 13.9966 33.0536 13.8479C32.8992 13.668 32.304 14.5259 32.9604 14.4129C32.7824 14.8404 32.6383 14.7189 32.5837 14.7896C32.1882 14.5777 32.0055 14.8272 32.3954 15.0721C32.3351 15.1389 32.2918 15.3226 32.1148 15.4977C31.6204 15.9865 30.8001 16.6296 30.1805 16.0156C29.9338 15.9497 30.0289 15.2613 29.8066 15.3555C29.4234 15.5175 29.0514 16.6852 28.1088 16.6767C27.2933 16.6692 27.2735 16.0288 27.216 15.4487C27.3432 15.4045 27.3008 15.267 27.3102 15.1662C27.3507 14.75 27.4957 14.459 27.4985 14.0362L27.6869 13.8488C27.6247 13.8431 27.5607 13.8535 27.4985 13.8488C27.3356 13.8337 26.7151 13.7537 26.651 13.7951C26.4297 13.9373 25.763 15.4836 25.5586 15.816C25.1603 16.462 24.5039 17.4828 23.6385 17.0506C23.6357 16.9611 23.4106 16.8038 23.356 16.6739C23.1507 16.187 23.389 15.332 23.3551 14.7905C22.9991 14.8809 23.0518 15.0193 23.0726 15.3555C22.92 15.4082 23.0349 14.9958 22.8409 15.2642C22.6149 15.5778 22.4313 16.0533 22.226 16.3914C22.1695 16.4846 22.0433 16.5957 21.9435 16.7681C21.7269 17.141 21.0554 18.5733 20.8615 18.7466C20.6232 18.9594 19.9358 18.8662 19.8717 18.5102C19.7116 17.6278 20.0959 16.7021 20.1081 15.8264C19.3152 16.9168 18.5731 18.1712 17.6126 19.1223C17.5533 19.1807 17.4779 19.2607 17.4243 19.3106C16.6718 20.0028 15.4326 20.7336 14.4108 20.8174C14.2149 20.8334 13.9484 20.8324 13.7516 20.8174C13.6593 20.8108 13.5567 20.8306 13.4691 20.8174C13.4465 20.8136 13.3608 20.743 13.2808 20.7232C12.0632 20.4162 11.4576 19.5451 11.209 18.3689C11.2203 18.0139 11.388 18.1571 11.3974 17.7098C11.4096 17.124 11.2637 16.85 11.3974 16.203C11.5433 15.4977 11.3042 16.1032 11.209 15.638C11.2269 15.5213 11.1893 15.3753 11.209 15.2613L11.3032 15.1672C11.3145 15.1088 11.2919 15.0363 11.3032 14.9788C11.4642 15.1493 11.7128 15.0645 11.5838 14.8856C11.5735 14.8715 11.323 14.9195 11.3974 14.6963C11.4341 14.5409 11.4501 14.3827 11.4915 14.2255H11.5857C11.8277 14.3187 11.9558 13.7151 11.6799 13.6605C11.6893 13.6322 11.6705 13.5945 11.6799 13.5663C12.0547 13.6096 11.9031 13.5531 11.9728 13.345C12.1008 12.9636 12.2807 12.6331 12.4116 12.2743C12.4728 12.1076 12.6319 11.8232 12.4332 11.6829C12.7638 10.9568 13.1179 10.1715 13.5633 9.51698C13.7563 9.52357 13.8505 9.42281 13.8458 9.23447C13.8929 9.17138 13.9211 9.08851 14.0341 8.95196C14.2357 8.709 14.2018 8.66757 14.3166 8.48111C15.2951 6.89435 17.4996 4.2962 19.4932 4.15118ZM24.1065 5.94041C23.8561 5.89332 23.9427 5.99314 23.8768 6.12875C23.3796 7.14578 23.0933 8.273 22.6949 9.32864C22.8899 9.37008 22.9144 9.23447 22.9963 9.11299C23.5604 8.273 23.9031 6.92919 24.1075 5.94041H24.1065ZM32.5818 14.6031C32.6496 14.4713 32.5225 14.3517 32.4895 14.4157C32.4217 14.5475 32.5489 14.6671 32.5818 14.6031ZM11.7006 14.6954C11.7006 14.6313 11.6488 14.5796 11.5848 14.5796C11.5207 14.5796 11.4689 14.6313 11.4689 14.6954C11.4689 14.7594 11.5207 14.8112 11.5848 14.8112C11.6488 14.8112 11.7006 14.7594 11.7006 14.6954ZM11.4868 15.5448C11.5019 15.5326 11.5754 15.2406 11.582 15.1691C11.4737 15.2284 11.2119 15.4563 11.3004 15.5448C11.3588 15.5391 11.4689 15.5599 11.4868 15.5448ZM34.7487 15.8292C34.0688 15.88 33.6554 16.5016 33.242 16.9573C33.5461 17.0741 34.8683 15.9252 34.7487 15.8292Z" fill="#577896"/>
            <path d="M32.489 9.4247C32.8111 9.55936 33.1482 9.71945 33.0898 10.1602C33.0842 10.2044 32.6576 10.8956 32.6265 10.9277C31.8025 11.7676 31.2874 10.4926 32.0182 9.61304C32.0596 9.56313 32.1867 9.53111 32.2065 9.4247C32.2329 9.43506 32.2715 9.41528 32.3007 9.4247C32.3515 9.44165 32.4447 9.40681 32.489 9.4247Z" fill="#577896"/>
            <path d="M7.37242 5.29297H8.02902L7.04132 8.65934C6.87858 9.21562 6.54748 9.39913 6.08169 9.39913H5.55978V8.83712H6.01996C6.28372 8.83712 6.40157 8.75109 6.48013 8.47009L6.55309 8.20628C6.16026 8.20628 6.00874 8.05717 5.81793 7.47795L5.09961 5.29297H5.77865L6.40718 7.24282C6.49697 7.51236 6.53625 7.62706 6.64849 7.62706H6.71583L7.37242 5.29297Z" fill="#577896"/>
            <path d="M2.68465 4.12305V5.70587C2.86984 5.40766 3.16727 5.22988 3.59939 5.22988C4.29526 5.22988 4.83962 5.68867 4.83962 6.76682C4.83962 7.78189 4.34577 8.29803 3.59939 8.29803C3.16727 8.29803 2.86984 8.12025 2.68465 7.82204V8.24068H2V4.12305H2.68465ZM3.40858 7.74175C3.90804 7.74175 4.15497 7.42633 4.15497 6.76682C4.15497 6.10158 3.90804 5.78616 3.40858 5.78616C2.92035 5.78616 2.68465 6.10158 2.68465 6.76682C2.68465 7.42633 2.92035 7.74175 3.40858 7.74175Z" fill="#577896"/>
            <g clip-path="url(#clip0_8383_10754)">
            <path d="M96.0583 4.50928V20.7581H94.0037V19.2872C93.2877 19.9301 92.479 20.4678 91.5397 20.7379C87.0591 22.0294 82.7564 18.3676 83.3881 13.7982C84.0829 8.76542 90.2484 6.54072 94.0037 10.0422V4.50928H96.0583ZM94.0964 14.6702C94.0964 12.2815 92.1381 10.3453 89.7223 10.3453C87.3065 10.3453 85.3482 12.2815 85.3482 14.6702C85.3482 17.0588 87.3065 18.995 89.7223 18.995C92.1381 18.995 94.0964 17.0588 94.0964 14.6702Z" fill="white"/>
            <path d="M110.646 14.6694C110.646 18.1645 107.78 20.9973 104.246 20.9973C100.711 20.9973 97.8457 18.1645 97.8457 14.6694C97.8457 11.1744 100.711 8.34155 104.246 8.34155C107.78 8.34155 110.646 11.1744 110.646 14.6694ZM108.619 14.6685C108.619 12.2799 106.661 10.3446 104.246 10.3446C101.831 10.3446 99.8725 12.2808 99.8725 14.6685C99.8725 17.0563 101.831 18.9924 104.246 18.9924C106.661 18.9924 108.619 17.0563 108.619 14.6685Z" fill="white"/>
            <path d="M70.6293 15.6448L75.9778 10.8134C77.0607 9.70796 77.3682 8.33412 76.5373 6.9667C74.9385 4.33259 70.7941 5.52875 70.8414 8.57134H68.2912C68.2662 5.84565 70.4106 3.39106 73.1516 3.04668C76.9403 2.57042 80.124 5.82824 79.4645 9.56874C78.9976 12.2175 76.1686 13.8441 74.4179 15.6448H70.6283H70.6293Z" fill="white"/>
            <path d="M52 18.2359L60.7898 3.04224L63.05 4.26403L56.3917 15.7145H60.0043V18.2359H52Z" fill="white"/>
            <path d="M116.175 8.5715H119.999V10.602H116.175V20.7574H114.12V10.602H111.074V8.5715H114.12V4.50952H116.068L116.175 4.61393V8.5715Z" fill="white"/>
            <path d="M80.4764 18.2358H67.7266V20.7573H80.4764V18.2358Z" fill="white"/>
            <path d="M65.1038 10.6018H62.625V20.7572H65.1038V10.6018Z" fill="white"/>
            </g>
            <defs>
            <clipPath id="clip0_8383_10754">
            <rect width="68" height="18" fill="white" transform="translate(52 3)"/>
            </clipPath>
            </defs>
          </svg>
    </div>

    <canvas id="grid-canvas"></canvas>
    <div id="dimensions-display"></div>
    
    <div id="container"></div>

    <div id="control-panel">
        <div id="control-panel-header" style="height: 10px; border-bottom: 1px solid #3b3b3b;">
            <!-- <div style="width: 100%; height: 20px; border-bottom: 1px solid #5b5b5b;"></div> -->
        </div>
        <div class="h1-header">Spawn Window</div>
        <div class="frame-select-container">
            <div class="dropdown-wrapper">
                <select id="frame-select" class="frame-dropdown">
                    <option value="" disabled selected>Select Screen Size</option>
                </select>
                <img src="assets/arrow.svg" class="dropdown-arrow" alt="▼">
            </div>
        </div>
        <div class="input-group" style="display: none;">
            <label>URL</label>
            <input type="text" id="url-input" value="https://www.figma.com/mirror" style="width: 100%;">
        </div>
        <div class="input-flex">
            <input type="number" id="width-input" value="10" min="1" max="66" placeholder="W (in)">
            <img src="assets/close.svg" alt="X" style="width: 20px; height: 20px; vertical-align: middle;">
            <input type="number" id="height-input" value="10" min="1" max="37" placeholder="H (in)">
        </div>
        <!-- Comment out the Launch Frame button -->
        <!-- <button id="launch-frame-button">Launch Frame</button> -->
        <button id="spawn-button">Spawn Empty Frame</button>
        <button id="spawn-image-button">Spawn Image</button>
        <input type="file" id="image-input" accept="image/*" style="display: none;">
        <button id="close-all-button">Close All Frames</button>
        
        <div class="toggle-switch-container" id="border-toggle-container">
          <input type="checkbox" id="border-toggle-checkbox" class="toggle-checkbox">
          <label for="border-toggle-checkbox" class="toggle-label">
            <span class="toggle-button"></span>
          </label>
          <span class="toggle-text">Border</span>
        </div>
        
        <div class="slider-container" id="border-thickness-slider-container" style="display: none;">
          <input type="range" id="border-thickness-slider" class="control-slider" min="0.05" max="0.5" step="0.01" value="0.25">
          <span id="border-thickness-value">0.25"</span>
        </div>

        <div class="toggle-switch-container">
          <input type="checkbox" id="toggle-controls-checkbox" class="toggle-checkbox">
          <label for="toggle-controls-checkbox" class="toggle-label">
            <span class="toggle-button"></span>
          </label>
          <span class="toggle-text">Frame Controls</span>
        </div>
        <div class="divider"></div>
        <div class="h1-header">Frame Presets</div>
        <div id="active-windows"></div>
        <div class="divider"></div>
        <div class="h1-header">Figma Frames</div>
        <div id="figma-frames-container">
            <!-- Frames will be added here dynamically -->
        </div>
    </div>
    
    <div class="grid-cursor"></div>
    <div id="brightness-control">
        <div class="controls-wrapper">
            <button id="toggle-grid" class="grid-toggle">
                <img src="assets/grid-go.svg" alt="Toggle Grid">
            </button>
            <input 
                type="range" 
                id="brightness-slider" 
                min="0" 
                max="100" 
                value="50"
                class="slider">
        </div>
    </div>

    <script src="grid.js"></script>
    <script>
        document.body.style.backgroundColor = '#000000';

        // Load monitor presets
        console.log('[Renderer] Attempting to load monitor presets...');
        fetch('monitor-presets.json')
            .then(response => {
                console.log('[Renderer] Fetch response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('[Renderer] Successfully loaded monitor presets data:', data);
                const presetsContainer = document.getElementById('monitor-presets');
                if (!presetsContainer) {
                    console.error('[Renderer] CRITICAL ERROR: Could not find #monitor-presets container element!');
                    return;
                }
                console.log('[Renderer] Found #monitor-presets container. Clearing and adding buttons...');
                presetsContainer.innerHTML = ''; // Clear existing buttons
                if (!data || !data.presets || !Array.isArray(data.presets)) {
                    console.error('[Renderer] Invalid presets data format:', data);
                    presetsContainer.innerHTML = '<p style="color:red;">Error: Invalid preset data format.</p>';
                    return;
                }
                data.presets.forEach((preset, index) => {
                    console.log(`[Renderer] Processing preset ${index}:`, preset);
                    if (!preset || typeof preset !== 'object') {
                        console.warn(`[Renderer] Skipping invalid preset at index ${index}:`, preset);
                        return; // Skip invalid preset entry
                    }
                    const button = document.createElement('button');
                    // Display name, dimensions in inches, and pixel dimensions if available
                    // Values are already in inches, no conversion needed
                    const widthInches = (preset.width !== null && preset.width !== undefined) ? preset.width.toFixed(1) : 'N/A';
                    const heightInches = (preset.height !== null && preset.height !== undefined) ? preset.height.toFixed(1) : 'N/A';
                    let buttonText = `${preset.name || 'Unnamed Preset'} | ${widthInches}×${heightInches}"`;
                    if (preset.pxWidth && preset.pxHeight) {
                        buttonText += ` (${preset.pxWidth}×${preset.pxHeight}px)`;
                    }
                    button.textContent = buttonText;
                    
                    // Store ALL preset data in dataset attributes - now in inches
                    button.dataset.width = preset.width;
                    button.dataset.height = preset.height;
                    button.dataset.pxWidth = preset.pxWidth || 'null'; // Use 'null' string for consistency
                    button.dataset.pxHeight = preset.pxHeight || 'null';
                    button.dataset.ppi = preset.ppi || 'null';
                    
                    button.onclick = () => {
                        console.log('[Renderer] Preset button clicked. Dataset:', button.dataset);
                        // Values are already in inches
                        const widthVal = parseFloat(button.dataset.width);
                        const heightVal = parseFloat(button.dataset.height);
                        // Update inputs only if values are valid numbers
                        if (!isNaN(widthVal)) {
                           document.getElementById('monitor-width').value = widthVal.toFixed(1);
                        }
                         if (!isNaN(heightVal)) {
                           document.getElementById('monitor-height').value = heightVal.toFixed(1);
                         }
                        // Store the full preset data globally or pass it to initializeGrid if needed
                        window.selectedPresetData = button.dataset; // Store globally for initializeGrid to access
                        initializeGrid();
                    };
                    presetsContainer.appendChild(button);
                });
                console.log('[Renderer] Finished adding monitor preset buttons.');
            })
            .catch(error => {
                 console.error('[Renderer] Error loading or processing monitor presets:', error);
                 const presetsContainer = document.getElementById('monitor-presets');
                 if(presetsContainer) {
                     presetsContainer.innerHTML = `<p style="color:red;">Error loading presets: ${error.message}</p>`;
                 } else {
                      console.error('[Renderer] Could not display error message because #monitor-presets container not found.')
                 }
             });

        console.log('Checking if initializeGrid is available:', typeof initializeGrid);
        // We'll add window spawning functionality here
        // Make control panel draggable
        const controlPanel = document.getElementById('control-panel');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        document.getElementById('control-panel-header').addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
            isDragging = true;
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                xOffset = currentX;
                yOffset = currentY;
                controlPanel.style.transform = 
                    `translate(${currentX}px, ${currentY}px)`;
            }
        }

        function dragEnd() {
            isDragging = false;
        }

        // Add this after the dragEnd function
        const controlPanelHeader = document.getElementById('control-panel-header');
        const controlPanelContent = document.getElementById('control-panel').children;
        let isPanelContentVisible = true;
        // Store original display values
        const originalDisplayValues = Array.from(controlPanelContent).slice(1).map(el => getComputedStyle(el).display);

        controlPanelHeader.addEventListener('dblclick', (e) => {
            isPanelContentVisible = !isPanelContentVisible;
            // Start from index 1 to skip the header (index 0)
            for (let i = 1; i < controlPanelContent.length; i++) {
                controlPanelContent[i].style.display = isPanelContentVisible ? originalDisplayValues[i-1] : 'none';
            }
        });

        // Window management
        let windows = [];
        let presets = [];  // Store presets separately from active windows

        let windowControlsVisible = false; // State for window controls visibility
        let borderEnabledState = false; // State for border visibility
        let currentBorderThickness = 0.25; // Default border thickness in inches

        const toggleControlsCheckbox = document.getElementById('toggle-controls-checkbox');
        const toggleControlsText = document.querySelector('.toggle-text'); // Get the text span

        toggleControlsCheckbox.addEventListener('change', () => {
          windowControlsVisible = toggleControlsCheckbox.checked;
          
          // No need to update button text anymore, the switch itself is the visual indicator
          // toggleControlsText.textContent = windowControlsVisible ? 'Controls ON' : 'Controls OFF'; // Optional: change text if desired
          
          document.querySelectorAll('.figma-window, .image-window').forEach(windowEl => {
            if (windowControlsVisible) {
              windowEl.classList.add('window-controls-visible');
            } else {
              windowEl.classList.remove('window-controls-visible');
            }
          });
        });

        const borderToggleCheckbox = document.getElementById('border-toggle-checkbox');
        const borderThicknessSlider = document.getElementById('border-thickness-slider');
        const borderThicknessValueDisplay = document.getElementById('border-thickness-value');
        const borderThicknessSliderContainer = document.getElementById('border-thickness-slider-container');

        borderToggleCheckbox.addEventListener('change', () => {
          borderEnabledState = borderToggleCheckbox.checked;
          if (borderEnabledState) {
            borderThicknessSliderContainer.classList.add('visible');
            borderThicknessSliderContainer.style.display = 'flex'; // Ensure it overrides inline style
          } else {
            borderThicknessSliderContainer.classList.remove('visible');
            borderThicknessSliderContainer.style.display = 'none';
          }
          // Call the main border update function (which we'll modify in grid.js)
          window.electron.updateBorderState(borderEnabledState, currentBorderThickness);
        });

        borderThicknessSlider.addEventListener('input', () => {
          currentBorderThickness = parseFloat(borderThicknessSlider.value);
          borderThicknessValueDisplay.textContent = `${currentBorderThickness.toFixed(2)}"`;
          // If border is already enabled, update its thickness
          if (borderEnabledState) {
            window.electron.updateBorderState(borderEnabledState, currentBorderThickness);
          }
        });

        function createWindow(config) {
            const container = document.getElementById('container');
            const windowEl = document.createElement('div');
            windowEl.className = 'figma-window';
            
            // Add size indicator
            const sizeIndicator = document.createElement('div');
            sizeIndicator.className = 'size-indicator';
            document.body.appendChild(sizeIndicator);

            // Convert directly to pixels using grid spacing
            const pxWidth = config.width * window.gridSystem.gridSpacingX;
            const pxHeight = config.height * window.gridSystem.gridSpacingY;
            windowEl.style.width = pxWidth + 'px';
            windowEl.style.height = pxHeight + 'px';
            
            // Center window
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const x = (config.x !== undefined) ? config.x : (screenWidth - pxWidth) / 2;
            const y = (config.y !== undefined) ? config.y : (screenHeight - pxHeight) / 2;
            windowEl.style.left = x + 'px';
            windowEl.style.top = y + 'px';

            // Add drag handle
            const dragHandle = document.createElement('div');
            dragHandle.className = 'window-drag-handle';
            dragHandle.innerHTML = '<img src="./assets/arrows.svg" alt="Move">';
            windowEl.appendChild(dragHandle);

            // Add close button
            const closeButton = document.createElement('button');
            closeButton.className = 'window-close-button';
            closeButton.innerHTML = '<img src="./assets/close.svg" alt="Close">';
            closeButton.onclick = () => {
                windowEl.remove();
            };
            windowEl.appendChild(closeButton);

            // Add save button
            const saveButton = document.createElement('button');
            saveButton.className = 'window-save-button';
            saveButton.innerHTML = '<img src="./assets/save.svg" alt="Save">';
            saveButton.onclick = () => {
                // Get the raw width/height values without 'px'
                const rawWidth = windowEl.style.width.replace('px', '');
                const rawHeight = windowEl.style.height.replace('px', '');
                
                // Convert directly to inches
                const widthInches = parseFloat((parseInt(rawWidth) / window.gridSystem.gridSpacingX).toFixed(1));
                const heightInches = parseFloat((parseInt(rawHeight) / window.gridSystem.gridSpacingY).toFixed(1));
                
                const config = {
                    url: document.getElementById('url-input').value,
                    width: parseFloat(widthInches), // Store as inches
                    height: parseFloat(heightInches) // Store as inches
                };
                presets.push(config);
                saveWindows();
                updateWindowList();
            };
            windowEl.appendChild(saveButton);

            // Add resize handle
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle se';
            windowEl.appendChild(resizeHandle);

            const webview = document.createElement('webview');
            webview.src = config.url;
            webview.style.width = '100%';
            webview.style.height = '100%';
            webview.style.border = 'none';
            windowEl.appendChild(webview);

            // Apply controls visibility class if needed
            if (windowControlsVisible) {
              windowEl.classList.add('window-controls-visible');
            }
            
            // ADD DRAG AND RESIZE LOGIC HERE
            // Make window draggable
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            
            dragHandle.addEventListener('mousedown', (e) => {
                bringToFront(windowEl); // Bring window to front when starting to drag
                isDragging = true;
                initialX = e.clientX - windowEl.offsetLeft;
                initialY = e.clientY - windowEl.offsetTop;
            });
        
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    windowEl.style.left = `${currentX}px`;
                    windowEl.style.top = `${currentY}px`;
                }
            });
        
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        
            // Make window resizable
            let isResizing = false;
            let initialWidth = 0;
            let initialHeight = 0;
            let initialMouseX = 0; // Renamed to avoid conflict
            let initialMouseY = 0; // Renamed to avoid conflict
            
            resizeHandle.addEventListener('mousedown', (e) => {
                bringToFront(windowEl); // Bring window to front when starting to resize
                isResizing = true;
                initialWidth = parseInt(windowEl.style.width);
                initialHeight = parseInt(windowEl.style.height);
                initialMouseX = e.clientX;
                initialMouseY = e.clientY;
                e.preventDefault(); // Prevent text selection during resize
            });
        
            document.addEventListener('mousemove', (e) => {
                if (isResizing) {
                    const width = initialWidth + (e.clientX - initialMouseX);
                    const height = initialHeight + (e.clientY - initialMouseY);
                    windowEl.style.width = `${width}px`;
                    windowEl.style.height = `${height}px`;
                    
                    // Update size indicator showing inches directly
                    sizeIndicator.style.display = 'block';
                    const widthInches = (width/window.gridSystem.gridSpacingX).toFixed(1);
                    const heightInches = (height/window.gridSystem.gridSpacingY).toFixed(1);
                    sizeIndicator.textContent = `${widthInches}" × ${heightInches}"`;
                    sizeIndicator.style.left = `${e.clientX + 20}px`;
                    sizeIndicator.style.top = `${e.clientY + 20}px`;
                }
            });
        
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    sizeIndicator.style.display = 'none';
                }
            });
            
            // Bring window to front when clicked
            windowEl.addEventListener('mousedown', () => {
                bringToFront(windowEl);
            });
            // END OF ADDED DRAG AND RESIZE LOGIC
            
            // ADD BACK CLICK-TO-PLACE LOGIC
            let placementMode = false;
            dragHandle.addEventListener('click', (e) => {
                // Toggle placement mode ONLY if not currently dragging
                if (!isDragging) {
                    e.stopPropagation(); // Prevent triggering window's mousedown
                    placementMode = !placementMode;
                    dragHandle.style.background = placementMode ? 
                        'rgba(0, 255, 0, 0.5)' : 'rgba(255, 165, 0, 0.7)'; // Green when active
                    
                    const cursor = document.querySelector('.grid-cursor');
                    if (placementMode) {
                        cursor.style.display = 'block';
                        document.addEventListener('mousemove', updateGridCursor);
                        // Add listener to container for placement click
                        document.getElementById('container').addEventListener('click', placeWindow, { once: true }); // Use once to auto-remove listener
                    } else {
                        cursor.style.display = 'none';
                        document.removeEventListener('mousemove', updateGridCursor);
                        // Explicitly remove listener if mode is toggled off
                        document.getElementById('container').removeEventListener('click', placeWindow);
                    }
                }
            });
            
            function placeWindow(e) {
                if (placementMode && e.target === document.getElementById('container')) {
                    const absoluteX = e.clientX;
                    const absoluteY = e.clientY;
                    
                    // Set target position to the click coordinates directly (aligns top-left corner)
                    const targetX = absoluteX;
                    const targetY = absoluteY;
                    
                    windowEl.style.transition = 'left 0.3s ease-out, top 0.3s ease-out'; // Add smooth transition
                    windowEl.style.left = `${targetX}px`;
                    windowEl.style.top = `${targetY}px`;
                    
                    // Remove transition after animation completes
                    setTimeout(() => {
                        windowEl.style.transition = '';
                    }, 300); // Match the transition duration
                    
                    // Exit placement mode
                    placementMode = false;
                    dragHandle.style.background = 'rgba(255, 165, 0, 0.7)'; // Reset handle color
                    const cursor = document.querySelector('.grid-cursor');
                    cursor.style.display = 'none';
                    document.removeEventListener('mousemove', updateGridCursor);
                } else if (placementMode) {
                    // If clicked on something else while in placement mode, just exit placement mode
                    placementMode = false;
                    dragHandle.style.background = 'rgba(255, 165, 0, 0.7)';
                    const cursor = document.querySelector('.grid-cursor');
                    cursor.style.display = 'none';
                    document.removeEventListener('mousemove', updateGridCursor);
                    // Re-add listener if needed, or handle appropriately
                    document.getElementById('container').removeEventListener('click', placeWindow);
                }
            }
            // END OF CLICK-TO-PLACE LOGIC
            
            container.appendChild(windowEl);
            updateWindowList();
            return windowEl;
        }

        function updateWindowList() {
            const listEl = document.getElementById('active-windows');
            listEl.innerHTML = '';
            
            presets.forEach((config, index) => {
                const windowItem = document.createElement('div');
                windowItem.style.padding = '8px';
                windowItem.style.marginBottom = '4px';
                windowItem.style.background = 'rgba(50, 50, 50, 0.5)';
                windowItem.style.borderRadius = '4px';
                windowItem.style.display = 'flex';
                windowItem.style.justifyContent = 'space-between';
                windowItem.style.alignItems = 'center';

                const urlText = document.createElement('div');
                // Already stored as inches, just format for display
                const widthInches = parseFloat(config.width).toFixed(1);
                const heightInches = parseFloat(config.height).toFixed(1);
                urlText.textContent = `${widthInches}×${heightInches}"`;
                urlText.style.fontSize = '12px';
                urlText.style.flexGrow = '1';
                windowItem.appendChild(urlText);

                const launchBtn = document.createElement('button');
                launchBtn.textContent = 'Launch';
                launchBtn.style.padding = '4px 8px';
                launchBtn.style.marginLeft = '8px';
                launchBtn.style.width = 'auto';
                launchBtn.style.fontSize = '12px';
                launchBtn.onclick = () => {
                    createWindow({...config, x: undefined, y: undefined});
                };
                windowItem.appendChild(launchBtn);

                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '<img src="./assets/delete.svg" alt="Delete" style="width: 16px; height: 16px;">';
                closeBtn.style.padding = '2px 6px';
                closeBtn.style.marginLeft = '8px';
                closeBtn.style.width = 'auto';
                closeBtn.style.display = 'flex';
                closeBtn.style.alignItems = 'center';
                closeBtn.style.justifyContent = 'center';
                closeBtn.onclick = () => {
                    presets.splice(index, 1);
                    saveWindows();
                    updateWindowList();
                };
                windowItem.appendChild(closeBtn);

                listEl.appendChild(windowItem);
            });
        }

        function removeWindow(index) {
            const container = document.getElementById('container');
            container.removeChild(container.children[index]);
            windows.splice(index, 1);
            saveWindows();
            updateWindowList();
        }

        function saveWindows() {
            localStorage.setItem('savedPresets', JSON.stringify(presets));
        }

        // Update spawn button handler to use inches
        document.getElementById('spawn-button').addEventListener('click', () => {
            // Get values directly in inches
            const config = {
                url: document.getElementById('url-input').value,
                width: parseFloat(document.getElementById('width-input').value),
                height: parseFloat(document.getElementById('height-input').value),
                x: undefined,
                y: undefined
            };
            createWindow(config);
        });

        // Add close all windows functionality
        document.getElementById('close-all-button').addEventListener('click', () => {
            const container = document.getElementById('container');
            while (container.firstChild) {
                container.firstChild.remove();
            }
        });

        // Load saved presets from localStorage
        try {
            const savedPresets = localStorage.getItem('savedPresets');
            if (savedPresets) {
                presets = JSON.parse(savedPresets);
                updateWindowList();
            }
        } catch (e) {
            console.error('Error loading saved presets:', e);
        }

        // Add cursor tracking function
        function updateGridCursor(e) {
            if (!window.gridSystem) return;
            
            const cursor = document.querySelector('.grid-cursor');
            cursor.style.setProperty('--cursor-size', window.gridSystem.gridSpacingX + 'px');
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
        }

        const brightnessSlider = document.getElementById('brightness-slider');
        const toggleGridBtn = document.getElementById('toggle-grid');
        const body = document.body;
        let isGridVisible = true;

        function updateGridLines(brightness) {
            const canvas = document.getElementById('grid-canvas');
            if (!canvas || !window.gridSystem) return;
            
            const ctx = canvas.getContext('2d');
            
            if (!isGridVisible) {
                canvas.classList.add('hidden');
                // Wait for fade out animation to complete before clearing
                setTimeout(() => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }, 500); // Match the transition duration
                return;
            }

            // Remove hidden class first to trigger fade in
            canvas.classList.remove('hidden');
            
            // Clear the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calculate grid color based on brightness
            const brightnessValue = brightness / 100;
            const rgbValue = Math.round(255 * (1 - brightnessValue));
            
            // Adjust grid line opacity for better visibility
            const lineOpacity = Math.max(0.3, 0.5 - (brightnessValue * 0.3)); // More visible at darker backgrounds
            ctx.strokeStyle = `rgba(${rgbValue}, ${rgbValue}, ${rgbValue}, ${lineOpacity})`;
            ctx.lineWidth = 1;

            // Calculate total inches - no conversion needed since width/height are already in inches
            const totalWidthInches = Math.ceil(window.gridSystem.monitorWidth);
            const totalHeightInches = Math.ceil(window.gridSystem.monitorHeight);
            
            // Use inch-based grid spacing
            const inchGridSpacingX = window.gridSystem.inchGridSpacingX || window.gridSystem.gridSpacingX;
            const inchGridSpacingY = window.gridSystem.inchGridSpacingY || window.gridSystem.gridSpacingY;

            // Draw vertical lines (inch-based)
            ctx.beginPath();
            for (let x = 0; x <= totalWidthInches; x++) {
                const xPos = x * inchGridSpacingX;
                ctx.moveTo(xPos, 0);
                ctx.lineTo(xPos, canvas.height);
            }

            // Draw horizontal lines (inch-based)
            for (let y = 0; y <= totalHeightInches; y++) {
                const yPos = y * inchGridSpacingY;
                ctx.moveTo(0, yPos);
                ctx.lineTo(canvas.width, yPos);
            }
            ctx.stroke();

            // Draw numbers with better visibility
            ctx.font = 'bold 10px sans-serif';
            const textOpacity = Math.max(0.7, 0.9 - (brightnessValue * 0.5)); // More visible at darker backgrounds
            ctx.fillStyle = `rgba(${rgbValue}, ${rgbValue}, ${rgbValue}, ${textOpacity})`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // X-axis numbers (in inches) - show all numbers
            for (let x = 1; x <= totalWidthInches; x++) {
                const xPos = x * inchGridSpacingX;
                // Display all inch markings
                ctx.fillText(x.toString() + "\"", xPos, 10);
                ctx.fillText(x.toString() + "\"", xPos, canvas.height - 10);
            }

            // Y-axis numbers (in inches) - show all numbers
            for (let y = 1; y <= totalHeightInches; y++) {
                const yPos = y * inchGridSpacingY;
                // Display all inch markings
                ctx.fillText(y.toString() + "\"", 10, yPos);
                ctx.fillText(y.toString() + "\"", canvas.width - 10, yPos);
            }
        }
        
        // Make updateGridLines available to grid.js
        window.updateGridLines = updateGridLines;

        // Toggle grid visibility
        toggleGridBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isGridVisible = !isGridVisible;
            
            // Update toggle button appearance
            toggleGridBtn.style.backgroundColor = isGridVisible ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.1)';
            toggleGridBtn.querySelector('img').style.opacity = isGridVisible ? '1' : '0.3';
            
            updateGridLines(brightnessSlider.value);
        });

        // Update background and grid contrast
        brightnessSlider.addEventListener('input', (e) => {
            const brightness = e.target.value;
            const brightnessValue = brightness / 100;
            body.style.backgroundColor = `rgba(255, 255, 255, ${brightnessValue})`;
            
            // We no longer update the grid when brightness changes
            // Only background color changes now
            console.log('Brightness changed: ' + brightness + '% - grid preserved');
        });

        // Modify the initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Hide controls initially
            const brightnessControl = document.getElementById('brightness-control');
            brightnessControl.style.display = 'none';
            
            // Ensure grid is visible initially
            isGridVisible = true;
        });

        function showControls() {
            const brightnessControl = document.getElementById('brightness-control');
            brightnessControl.style.display = 'block';
            
            // Make control panel visible
            const controlPanel = document.getElementById('control-panel');
            controlPanel.classList.add('visible');
            
            // Set initial background and grid state
            body.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
            updateGridLines(50); // This will now draw the grid since isGridVisible is true
        }
        
        // Make showControls globally available
        window.showControls = showControls;

        // Call showControls after grid is generated
        function generateGrid() {
            // ... existing grid generation code ...

            // After grid is generated
            showControls();
        }

        function createImageWindow(config) {
            const container = document.getElementById('container');
            const windowEl = document.createElement('div');
            windowEl.className = 'figma-window image-window';
            
            // Convert directly to pixels using grid spacing
            const pxWidth = config.width * window.gridSystem.gridSpacingX;
            const pxHeight = config.height * window.gridSystem.gridSpacingY;
            windowEl.style.width = pxWidth + 'px';
            windowEl.style.height = pxHeight + 'px';
            
            // Center window
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const x = (config.x !== undefined) ? config.x : (screenWidth - pxWidth) / 2;
            const y = (config.y !== undefined) ? config.y : (screenHeight - pxHeight) / 2;
            windowEl.style.left = x + 'px';
            windowEl.style.top = y + 'px';

            // Add drag handle
            const dragHandle = document.createElement('div');
            dragHandle.className = 'window-drag-handle';
            dragHandle.innerHTML = '<img src="./assets/arrows.svg" alt="Move">';
            windowEl.appendChild(dragHandle);

            // Add close button
            const closeButton = document.createElement('button');
            closeButton.className = 'window-close-button';
            closeButton.innerHTML = '<img src="./assets/close.svg" alt="Close">';
            closeButton.onclick = () => {
                // Revoke the object URL when closing the window
                if (img.src.startsWith('blob:')) {
                    URL.revokeObjectURL(img.src);
                }
                windowEl.remove();
            };
            windowEl.appendChild(closeButton);

            // Add the image
            const img = document.createElement('img');
            img.onload = function() {
                // Create canvas for high-quality rendering
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size to match image dimensions
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                
                // Enable high-quality image smoothing
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                // Draw image onto canvas
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Replace original image with canvas
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.objectFit = 'contain';
                windowEl.appendChild(canvas);
            };
            
            img.src = config.imageUrl;

            // Add resize handle
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle se';
            windowEl.appendChild(resizeHandle);

            // Add size indicator
            const sizeIndicator = document.createElement('div');
            sizeIndicator.className = 'size-indicator';
            document.body.appendChild(sizeIndicator);

            // Add resize functionality
            let isResizing = false;
            let initialMouseX = 0;
            let initialMouseY = 0;
            let initialWidth = 0;
            let initialHeight = 0;
            
            function handleMouseMove(e) {
                if (isResizing) {
                    const width = initialWidth + (e.clientX - initialMouseX);
                    const height = initialHeight + (e.clientY - initialMouseY);
                    windowEl.style.width = `${width}px`;
                    windowEl.style.height = `${height}px`;
                    
                    // Update size indicator showing inches
                    sizeIndicator.style.display = 'block';
                    const widthInches = (width/window.gridSystem.gridSpacingX).toFixed(1);
                    const heightInches = (height/window.gridSystem.gridSpacingY).toFixed(1);
                    sizeIndicator.textContent = `${widthInches}" × ${heightInches}"`;
                    sizeIndicator.style.left = `${e.clientX + 20}px`;
                    sizeIndicator.style.top = `${e.clientY + 20}px`;
                }
            }
            
            function handleMouseUp() {
                if (isResizing) {
                    isResizing = false;
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    sizeIndicator.style.display = 'none';
                }
            }

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                initialMouseX = e.clientX;
                initialMouseY = e.clientY;
                initialWidth = parseInt(windowEl.style.width);
                initialHeight = parseInt(windowEl.style.height);
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                e.preventDefault();
            });

            // Clean up event listeners when window is closed
            closeButton.addEventListener('click', () => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                sizeIndicator.remove();
                // Revoke the object URL when closing
                if (img.src.startsWith('blob:')) {
                    URL.revokeObjectURL(img.src);
                }
                windowEl.remove();
            });

            // Apply controls visibility class if needed
            if (windowControlsVisible) {
              windowEl.classList.add('window-controls-visible');
            }
            
            container.appendChild(windowEl);
            updateWindowList();
            return windowEl;
        }

        // Add click handler for spawn image button
        document.getElementById('spawn-image-button').addEventListener('click', () => {
            document.getElementById('image-input').click();
        });

        // Update the image input handler
        document.getElementById('image-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Revoke any previous object URL for this file if it exists
                const imageUrl = URL.createObjectURL(file);
                const config = {
                    width: document.getElementById('width-input').value,
                    height: document.getElementById('height-input').value,
                    imageUrl: imageUrl
                };
                createImageWindow(config);
                // Reset the input so the same file can be selected again
                e.target.value = '';
            }
        });

        // Add this in the script section after the other event listeners
        document.getElementById('border-toggle').addEventListener('click', () => {
            toggleBorder();
        });

        // Add this near the top of your script section
        // Function to handle incoming Figma frames
        function handleFigmaFrames(frames) {
            const container = document.getElementById('figma-frames-container');
            container.innerHTML = ''; // Clear existing frames
            
            frames.forEach(frame => {
                const frameItem = document.createElement('div');
                frameItem.className = 'figma-frame-item';
                frameItem.style.padding = '8px';
                frameItem.style.marginBottom = '4px';
                frameItem.style.background = 'rgba(50, 50, 50, 0.5)';
                frameItem.style.borderRadius = '4px';
                frameItem.style.display = 'flex';
                frameItem.style.justifyContent = 'space-between';
                frameItem.style.alignItems = 'center';

                const frameInfo = document.createElement('div');
                frameInfo.textContent = `${frame.name} (${frame.width}×${frame.height}")`;
                frameInfo.style.fontSize = '12px';
                frameInfo.style.flexGrow = '1';
                frameItem.appendChild(frameInfo);

                const launchBtn = document.createElement('button');
                launchBtn.textContent = 'Launch';
                launchBtn.style.padding = '4px 8px';
                launchBtn.style.marginLeft = '8px';
                launchBtn.style.width = 'auto';
                launchBtn.style.fontSize = '12px';
                launchBtn.onclick = () => {
                    createWindow({
                        width: frame.width,
                        height: frame.height,
                        url: frame.url || document.getElementById('url-input').value,
                        x: undefined,
                        y: undefined
                    });
                };
                frameItem.appendChild(launchBtn);

                container.appendChild(frameItem);
            });
        }

        // Add message listener for Figma plugin communication
        window.onmessage = (event) => {
            // Verify the message is from Figma
            if (event.data.pluginMessage && event.data.pluginMessage.type === 'figma-frames') {
                handleFigmaFrames(event.data.pluginMessage.frames);
            }
        };

        function toggleBorder() {
            borderEnabledState = !borderEnabledState;
            const toggleButton = document.getElementById('border-toggle');
            toggleButton.style.background = borderEnabledState ? '#437eba' : '#426e9b';
            toggleButton.textContent = borderEnabledState ? 'Border On' : 'Border Off';
            
            const windows = document.querySelectorAll('.figma-window');
            windows.forEach(windowEl => {
                if (borderEnabledState) {
                    windowEl.style.setProperty('--border-width', `${0.5 * gridSpacingX}px`);
                    windowEl.classList.add('border-enabled');
                } else {
                    windowEl.classList.remove('border-enabled');
                }
            });
        }
    </script>
</body>
</html> 